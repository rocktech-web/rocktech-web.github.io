<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock Technology | Land Management Suite</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* =========================================
           GLOBAL VARIABLES (FOR BOTH APPS)
           ========================================= */
        :root {
            /* ORIGINAL ROCKTECH CSS VARS */
            --primary: #2c3e50;
            --accent: #e67e22;
            --bg-body: #f4f6f9;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;

            /* CAD TOOL VARS (Moved to root for floating popup support) */
            --cad-bg-panel: #ffffff;
            --cad-text-main: #0f172a;
            --cad-text-muted: #475569;
            --cad-border-light: #e2e8f0;
            --cad-border-dark: #cbd5e1;
            --cad-primary: #2563eb; 
            --cad-primary-hover: #1d4ed8;
            --cad-secondary: #0f172a; 
            --cad-secondary-hover: #1e293b;
            --cad-success: #059669; 
            --cad-danger: #dc2626; 
            --print-border: #000000;
        }

        /* =========================================
           ORIGINAL ROCKTECH CSS (UNTOUCHED LOGIC)
           ========================================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        /* LOGIN CSS */
        #loginOverlay {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(135deg, #2c3e50 0%, #000 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 15px;
            width: 320px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .login-card input {
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd;
            border-radius: 6px; box-sizing: border-box; font-size: 16px;
        }

        /* NAVIGATION BAR */
        .navbar {
            position: fixed; top: 0; left: 0; right: 0;
            background: var(--primary); height: 60px;
            display: flex; justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        
        .nav-brand {
            color: #fff; font-weight: bold; font-size: 1.1rem; letter-spacing: 0.5px;
        }
        .nav-contact {
            color: var(--accent); font-weight: bold; font-family: monospace; font-size: 1.1rem;
        }
        .nav-center {
            display: flex; height: 100%;
        }

        .tab-btn {
            background: transparent; border: none; color: #b0bec5;
            padding: 0 20px; height: 100%; font-size: 15px; font-weight: 600;
            cursor: pointer; transition: var(--transition); border-bottom: 4px solid transparent;
        }
        .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { color: white; border-bottom-color: var(--accent); background: rgba(255,255,255,0.1); }

        /* CONTENT LAYOUT */
        #mainApp { display: none; width: 95%; max-width: 1200px; margin-bottom: 50px; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        
        .card {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid #eee;
        }
        .section-title {
            font-size: 1.4rem; color: var(--primary); margin: 0 0 20px 0;
            border-left: 5px solid var(--accent); padding-left: 15px; display: flex; justify-content: space-between;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        textarea, input[type="text"], input[type="number"], input[type="file"] {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;
            font-family: inherit; font-size: 14px; box-sizing: border-box;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus { border-color: var(--accent); outline: none; }
        button.btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: var(--transition);
        }
        button.btn:hover { background: var(--accent); transform: translateY(-1px); }
        button.btn-outline { background: transparent; border: 1px solid #999; color: #555; }
        button.btn-outline:hover { background: #eee; }

        /* TABLE STYLES (Scoped to #mainApp to avoid breaking CAD Print Layout) */
        #mainApp .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #e0e0e0; }
        #mainApp table { width: 100%; border-collapse: collapse; background: white; min-width: 800px; }
        #mainApp th { background: #f8f9fa; color: #555; padding: 12px; text-align: left; border-bottom: 2px solid #eee; }
        #mainApp td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; }
        
        .fraction-input { width: 80px; text-align: center; border: 1px solid #ddd; }
        .res-text { font-family: monospace; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile Adjustments */
        @media (max-width: 768px) { 
            .grid { grid-template-columns: 1fr; } 
            .navbar { flex-wrap: wrap; height: auto; padding: 10px; justify-content: center; gap: 10px; }
            .nav-brand, .nav-contact { width: 100%; text-align: center; }
            .nav-center { width: 100%; justify-content: center; flex-wrap: wrap; }
            .tab-btn { padding: 10px; flex: 1 1 30%; text-align: center; font-size: 13px;}
            body { padding-top: 140px; } 
        }

        /* =========================================
           NAZRI NAKSHA (CAD TOOL) SPECIFIC CSS
           ========================================= */
        #nakshaTab {
            font-family: 'Poppins', sans-serif;
            color: var(--cad-text-main);
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        #nakshaTab.active { display: flex; } 

        .cad-header { text-align: center; margin-bottom: 15px; width: 100%; }
        .cad-header h1 { color: var(--cad-secondary); margin-bottom: 2px; font-size: 26px; font-weight: 700; letter-spacing: -0.5px;}
        .cad-header p { color: var(--cad-text-muted); font-size: 14px; margin: 0; font-weight: 500;}

        .cad-panel { 
            background: var(--cad-bg-panel); padding: 12px 20px; border-radius: 8px; 
            border: 1px solid var(--cad-border-light); box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            margin-bottom: 12px; width: 100%; max-width: 1100px; display: flex; gap: 10px; 
            flex-wrap: wrap; justify-content: center; align-items: center; box-sizing: border-box;
        }

        .cad-btn { 
            padding: 8px 14px; border: 1px solid var(--cad-border-dark); border-radius: 6px; 
            background: #f1f5f9; color: #334155; font-weight: 600; font-family: 'Poppins', sans-serif; 
            font-size: 13px; cursor: pointer; transition: all 0.2s ease; display: flex; 
            align-items: center; justify-content: center; outline: none; box-shadow: none;
        }
        .cad-btn:hover { background: #e2e8f0; transform: none; }
        
        .active-tool { background: #eff6ff !important; border-color: #7dd3fc !important; color: #0284c7 !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }

        .cad-btn-primary { background: var(--cad-primary); border-color: var(--cad-primary); color: white; }
        .cad-btn-primary:hover { background: var(--cad-primary-hover); border-color: var(--cad-primary-hover); color: white;}
        .cad-btn-dark { background: var(--cad-secondary); border-color: var(--cad-secondary); color: white; }
        .cad-btn-dark:hover { background: var(--cad-secondary-hover); border-color: var(--cad-secondary-hover); color: white;}
        .cad-btn-success { background: var(--cad-success); border-color: var(--cad-success); color: white; }
        .cad-btn-danger { background: var(--cad-danger); border-color: var(--cad-danger); color: white; }
        .cad-btn-danger-outline { border-color: var(--cad-danger); color: var(--cad-danger); background: transparent; }
        .cad-btn-danger-outline:hover { background: #fee2e2; }

        .cad-control-group { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: var(--cad-text-muted); background: #f8fafc; padding: 6px 12px; border-radius: 6px; border: 1px solid var(--cad-border-light);}
        .cad-number-input { width: 45px !important; padding: 4px !important; border: 1px solid var(--cad-border-dark) !important; border-radius: 4px !important; font-family: 'Poppins', sans-serif; font-weight: 600; text-align: center; color: var(--cad-text-main);}
        .cad-text-input { padding: 6px 10px !important; border: 1px solid var(--cad-border-dark) !important; border-radius: 4px !important; font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 13px; width: 180px !important;}

        .viewport { width: 160mm; height: 174mm; border: 1px solid var(--cad-border-dark); background: #e2e8f0; overflow: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; border-radius: 4px;}
        .canvas-wrapper { width: 160mm; height: 174mm; background: white; transform-origin: top left; transition: transform 0.1s ease; position: relative; }
        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }
        
        #instruction { color: var(--cad-primary); font-weight: 600; margin-bottom: 10px; text-align: center; font-size: 14px;}
        
        .floating-input-container { position: absolute; background: white; border: 1px solid var(--cad-border-dark); border-radius: 6px; padding: 10px; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 8px;}
        .floating-textarea { font-family: 'Poppins', sans-serif; font-size: 14px; padding: 8px; font-weight: 500; outline: none; border: 1px solid var(--cad-border-dark); border-radius: 4px; resize: both; min-width: 200px; min-height: 60px;}
        #cadDistanceBox { display: none; position: absolute; background: var(--cad-secondary); color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600; pointer-events: none; z-index: 10; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}

        .cad-form-group { margin-bottom: 10px; width: 100%;}
        .cad-form-group label { display: block; font-weight: 600; color: var(--cad-text-muted); margin-bottom: 4px; font-size: 12px;}
        .cad-form-group input, .cad-form-group textarea { width: 100%; padding: 8px !important; border: 1px solid var(--cad-border-dark) !important; border-radius: 6px !important; font-family: inherit; font-size: 13px; box-sizing: border-box; background: #ffffff; transition: 0.2s;}
        .cad-form-group input:focus, .cad-form-group textarea:focus { outline: none; border-color: var(--cad-primary) !important; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);}

        .cad-divider { width: 1px; height: 24px; background: var(--cad-border-dark); margin: 0 5px; }

        /* =========================================
           A4 PRINT CSS (FIXED FOR PROPER ALIGNMENT)
           ========================================= */
        #printArea { display: none; }
        
        @media print {
            @page { size: A4; margin: 10mm; }
            body { margin: 0; padding: 0; background-color: #fff; display: block !important; }
            
            /* HIDE EVERYTHING EXCEPT PRINT AREA */
            body > *:not(#printArea) { display: none !important; }
            
            #printArea { 
                display: block !important; position: absolute; left: 0; top: 0; width: 100%; 
                font-family: 'Poppins', sans-serif; color: #000; 
            }
            .document-container {
                width: 190mm; height: 277mm; margin: 0 auto; background-color: #fff;
                border: 1px solid var(--print-border); box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; 
            }
            .bold { font-weight: 700 !important; }
            .regular { font-weight: 400 !important; }
            .font-14 { font-size: 14pt !important; }
            .font-11 { font-size: 11pt !important; }

            .header-table { width: 100%; border-collapse: collapse; border-bottom: 1px solid var(--print-border); }
            .header-table > tbody > tr > td { border-right: 1px solid var(--print-border); padding: 8px 10px; vertical-align: top; line-height: 1.5; }
            .header-table > tbody > tr > td:last-child { border-right: none; }
            .header-left { width: 55%; }
            .header-mid { width: 30%; padding: 0 !important; }
            .header-right { width: 15%; text-align: center; vertical-align: middle !important; }
            .compass-img { width: 80px; height: auto; }

            .mid-table { width: 100%; height: 100%; border-collapse: collapse; }
            .mid-table td { border-bottom: 1px solid var(--print-border); padding: 10px; }
            .mid-table tr:last-child td { border-bottom: none; }
            .title-cell { text-align: center; vertical-align: middle; height: 5px; }
            .date-cell { text-align: center; vertical-align: bottom; height: 30px; padding-bottom: 10px; }

            .map-area { flex-grow: 1; min-height: 0; border-bottom: 1px solid var(--print-border); display: flex; justify-content: center; align-items: center; padding: 5px; box-sizing: border-box; overflow: hidden; }
            .map-area img { max-width: 100%; max-height: 100%; object-fit: contain; }

            .declaration-text { padding: 12px; text-align: center; }
            .signature-line { padding: 6px 10px; }

            .footer-layout-table { width: 100%; border-collapse: collapse; border-top: 1px solid var(--print-border); }
            .footer-layout-table > tbody > tr > td { vertical-align: top; }
            .footer-details-table { width: 100%; border-collapse: collapse; height: 100%; }
            .footer-details-table td { border-right: 1px solid var(--print-border); border-bottom: 1px solid var(--print-border); padding: 10px; vertical-align: middle; }
            .footer-details-table tr:last-child td { border-bottom: none; }
            .label-col { width: 30%; text-align: right; padding-right: 15px; }
            .value-col { width: 70%; }
            .patwari-block { display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; height: 100%; min-height: 140px; padding: 15px 10px; box-sizing: border-box; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2 style="margin-top:0; color:var(--primary);">Rock Technology</h2>
            <p>Secure Access</p>
            <input type="text" id="userId" placeholder="User ID">
            <input type="password" id="password" placeholder="Password">
            <button class="btn" style="width:100%; margin-top:15px;" onclick="checkLogin()">LOGIN</button>
            <p id="loginError" style="color:red; display:none; margin-top:10px; font-size:14px;">Invalid Credentials!</p>
        </div>
    </div>

    <nav class="navbar" id="navBar" style="display:none;">
        <div class="nav-brand">RockTechnology</div>
        <div class="nav-center">
            <button class="tab-btn active" onclick="openTab(event, 'extTab')">B1 Extractor</button>
            <button class="tab-btn" onclick="openTab(event, 'batTab')">Batwara Calc</button>
            <button class="tab-btn" onclick="openTab(event, 'fracTab')">Fraction Calc</button>
            <button class="tab-btn" onclick="openTab(event, 'fmtTab')">Data Formatter</button>
            <button class="tab-btn" onclick="openTab(event, 'nakshaTab')">Nazri Naksha</button>
            <button class="tab-btn" onclick="openTab(event, 'newToolTab')">Trace Naksha</button>
            <button class="tab-btn" onclick="openTab(event, 'downTab')">Download Formats</button>
            <button class="tab-btn" onclick="openTab(event, 'traceNaksha')">Trace Naksha</button>
        </div>
        <div class="nav-contact">7869731689</div>
    </nav>

    <div id="mainApp">
        <div id="extTab" class="tab-content active">
            <div class="card">
                <div class="section-title">MP Land Records Extractor (Smart Logic)</div>
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; display:flex; gap:10px; align-items:center;">
                    <input type="file" id="fileInput" accept=".txt" style="border:none;">
                    <button class="btn" onclick="processLandData()">Extract Data</button>
                </div>
            </div>
            <div class="grid">
                <div class="card">
                    <div class="section-title">Owners & Shares <button class="btn btn-outline" style="font-size:12px; padding:5px 10px;" onclick="copyData('ownersOutput')">Copy</button></div>
                    <textarea id="ownersOutput" rows="12" placeholder="Owner Names and Shares will appear here..."></textarea>
                </div>
                <div class="card">
                    <div class="section-title">Khasara & Area <button class="btn btn-outline" style="font-size:12px; padding:5px 10px;" onclick="copyData('khasaraOutput')">Copy</button></div>
                    <textarea id="khasaraOutput" rows="12" placeholder="Village, Khata and Khasara details..."></textarea>
                </div>
            </div>
        </div>

        <div id="batTab" class="tab-content">
            <div class="card">
                <div class="section-title">
                    <span>‡§¨‡§ü‡§µ‡§æ‡§∞‡§æ ‡§ó‡§£‡§®‡§æ (Proportional Renormalization)</span>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 3fr;">
                    <div style="background:#fff8e1; padding:15px; border-radius:8px; border:1px solid #ffe0b2;">
                        <label style="font-weight:bold; color:#f57c00;">‡§ï‡•Å‡§≤ ‡§∞‡§ï‡§¨‡§æ (Total Area)</label>
                        <input type="text" id="totalArea" value="0.6000" style="margin-top:5px; font-weight:bold;">
                        <button class="btn" style="width:100%; margin-top:15px;" onclick="parseAndLoad()">‡§°‡§æ‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</button>
                    </div>
                    <div>
                        <textarea id="rawInput" rows="5" placeholder="‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ..."></textarea>
                    </div>
                </div>
            </div>
            <div class="card" style="padding:0; overflow:hidden;">
                <div class="table-wrap">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th width="5%">‡§ï‡•ç‡§∞.</th>
                                <th width="20%">‡§®‡§æ‡§Æ</th>
                                <th width="10%">‡§Æ‡•Ç‡§≤ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ</th>
                                <th width="25%">‡§π‡§ü‡§æ‡§®‡§æ (‡§∞‡§ï‡§¨‡§æ ‡§Ø‡§æ FULL)</th>
                                <th width="10%">‡§ò‡§ü‡§æ‡§Ø‡§æ ‡§≠‡§ø‡§®‡•ç‡§®</th>
                                <th width="10%">‡§∂‡•á‡§∑ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ</th>
                                <th width="20%">‡§™‡•Å‡§®‡§∞‡•ç‡§®‡§ø‡§ß‡§æ‡§∞‡§ø‡§§ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="padding:15px; background:#f1f1f1; text-align:right;">
                    <button class="btn" onclick="calculate()">‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç (Calculate)</button>
                </div>
            </div>
            <div id="outputPanel" class="card" style="display:none; background:#e8f5e9; border:1px solid #c8e6c9;">
                <div class="section-title" style="border-left-color:#2e7d32; margin-bottom:10px;">
                    <span style="color:#2e7d32;">‡§™‡§∞‡§ø‡§£‡§æ‡§Æ</span>
                    <button class="btn" style="background:#2e7d32;" onclick="copyBatwaraResult()">Copy Text</button>
                </div>
                <div id="resultText" style="background:white; padding:15px; border-radius:6px; font-family:monospace; margin-bottom:10px; border:1px solid #ccc;"></div>
            </div>
        </div>

        <div id="fracTab" class="tab-content">
            <div class="card">
                <div class="section-title">Fraction Tools</div>
                <div class="grid">
                    <div>
                        <label><b>Add Fractions</b></label>
                        <textarea id="sumInput" rows="3"></textarea>
                        <button class="btn" style="margin-top:5px;" onclick="calculateSum()">Sum</button>
                        <div id="sumResult" class="res-text" style="margin-top:10px; color:var(--accent);"></div>
                    </div>
                    <div>
                        <label><b>Subtract / Divide</b></label>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <input type="text" id="subMain" placeholder="Main">
                            <input type="text" id="subValues" placeholder="Sub">
                        </div>
                        <button class="btn" style="margin-top:5px;" onclick="calculateSub()">Subtract</button>
                        <div id="subResult" class="res-text" style="margin-top:5px; color:var(--accent);"></div>
                        
                        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <div style="display:flex; gap:10px;">
                                <input type="text" id="divMain" placeholder="Frac">
                                <input type="number" id="divCount" placeholder="Parts">
                            </div>
                            <button class="btn" style="margin-top:5px;" onclick="calculateDiv()">Divide</button>
                            <div id="divResult" class="res-text" style="margin-top:5px; color:var(--accent);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="fmtTab" class="tab-content">
            <div class="card">
                <div class="section-title">Data Formatter (Table Generator)</div>
                <div class="grid" style="grid-template-columns: 1fr;">
                    <div>
                        <label><b>‡§°‡§æ‡§ü‡§æ ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç (Comma Separated):</b></label>
                        <textarea id="fmtInput" rows="5" placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: ‡§∞‡§æ‡§Æ 1/4, ‡§∂‡•ç‡§Ø‡§æ‡§Æ 1/4..."></textarea>
                        <button class="btn" style="margin-top:15px;" onclick="processFmt()">Format Data</button>
                    </div>
                </div>
            </div>

            <div id="fmtResult" class="grid" style="display:none; grid-template-columns: 1fr 2fr;">
                <div class="card">
                    <div class="section-title">
                        <span>Table 1: ‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£</span>
                        <button class="btn btn-outline" style="font-size:11px; padding:2px 8px;" onclick="copyTable('tblRaw')">Copy</button>
                    </div>
                    <div class="table-wrap">
                        <table id="tblRaw">
                            <thead><tr><th>‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‚Äç‡§µ‡§æ‡§Æ‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ + ‡§π‡§ø‡§∏‡•ç‚Äç‡§∏‡§æ</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <div class="section-title">
                        <span>Table 2: ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£</span>
                        <button class="btn btn-outline" style="font-size:11px; padding:2px 8px;" onclick="copyTable('tblDetail')">Copy</button>
                    </div>
                    <div class="table-wrap">
                        <table id="tblDetail">
                            <thead>
                                <tr><th>‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‚Äç‡§µ‡§æ‡§Æ‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§π‡§ø‡§∏‡•ç‚Äç‡§∏‡§æ</th><th>‡§Ö‡§Ç‡§∂</th><th>‡§π‡§∞</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="nakshaTab" class="tab-content">
            <div class="cad-header">
                <h1>RockTechnology - Master CAD</h1>
                <p>‡§™‡•ç‡§∞‡•ã‡§´‡•á‡§∂‡§®‡§≤ ‡§®‡•õ‡§∞‡•Ä ‡§®‡§ï‡•ç‡§∂‡§æ ‡§è‡§µ‡§Ç ‡§∞‡§æ‡§ú‡§∏‡•ç‡§µ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡•õ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞</p>
            </div>

            <input type="file" id="projectInput" accept=".json" style="display: none;" />

            <div class="cad-panel">
                <button class="cad-btn" onclick="document.getElementById('projectInput').click()">‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§ñ‡•ã‡§≤‡•á‡§Ç</button>
                <button class="cad-btn" onclick="saveProject()">‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                <div class="cad-divider"></div>
                <button class="cad-btn" onclick="changeZoom(0.2)">‡•õ‡•Ç‡§Æ ‡§á‡§® (+)</button>
                <button class="cad-btn" onclick="changeZoom(-0.2)">‡•õ‡•Ç‡§Æ ‡§Ü‡§â‡§ü (-)</button>
                <div class="cad-divider"></div>
                <button class="cad-btn" onclick="undo()">Undo</button>
                <button class="cad-btn" onclick="redo()">Redo</button>
                <div class="cad-divider"></div>
                <button class="cad-btn" onclick="resetCanvasState()">‡§®‡§Ø‡§æ ‡§®‡§ï‡•ç‡§∂‡§æ (Reset)</button>
            </div>

            <div class="cad-panel" id="drawToolbar">
                <label class="cad-btn cad-btn-dark">‡§á‡§Æ‡•á‡§ú ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç <input type="file" id="imageInput" accept="image/*" style="display: none;" /></label>
                <div class="cad-divider"></div>
                <button class="cad-btn" id="btnMain" onclick="setMode('main')">‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡§æ‡§∞‡•ç‡§ó (Red)</button>
                <button class="cad-btn" id="btnLink" onclick="setMode('link')">‡§≤‡§ø‡§Ç‡§ï ‡§Æ‡§æ‡§∞‡•ç‡§ó (Yellow)</button>
                <button class="cad-btn" id="btnKachchi" onclick="setMode('kachchi')">‡§ï‡§ö‡•ç‡§ö‡§æ ‡§∞‡§æ‡§∏‡•ç‡§§‡§æ (Dash)</button>
                <button class="cad-btn" id="btnRail" onclick="setMode('rail')">‡§∞‡•á‡§≤ ‡§≤‡§æ‡§á‡§®</button>
                <button class="cad-btn" id="btnPlot" onclick="setMode('plot')">‡§™‡•ç‡§≤‡•â‡§ü ‡§≤‡§æ‡§á‡§®</button>
                <button class="cad-btn" id="btnText" onclick="setMode('text')">‡§´‡•ç‡§∞‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü</button>
                <div class="cad-divider"></div>
                <button class="cad-btn cad-btn-primary" onclick="generateLineArt()">‡§≤‡§æ‡§á‡§® ‡§Ü‡§∞‡•ç‡§ü ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>

            <div class="cad-panel" id="docDetailsPanel" style="display: none; flex-direction: column; align-items: stretch; gap: 5px; background: #f0fdfa; border-color: #5eead4;">
                <div style="font-weight: 700; color: var(--cad-success); border-bottom: 1px solid #ccfbf1; padding-bottom: 8px; margin-bottom: 5px; font-size: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span>üìù ‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡•õ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ (A4 Print)</span>
                    <span style="font-size: 12px; color: var(--cad-text-muted); font-weight: 500;">‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§Ø‡§π ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡•Ä ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§</span>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="cad-form-group" style="flex: 1; min-width: 250px; margin-bottom: 0;">
                        <label>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ (‡§ä‡§™‡§∞ ‡§¨‡§æ‡§à‡§Ç ‡§ì‡§∞):</label>
                        <textarea id="docOffice" rows="4" style="resize: vertical;">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§ü‡§µ‡§æ‡§∞‡•Ä ‡§π‡§≤‡•ç‡§ï‡§æ ‡§¨‡•à‡§¢‡§º‡§®, ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï 14&#10;‡§∞‡§æ.‡§®‡§ø. ‡§Æ‡§£‡•ç‡§°‡§≤: ‡§¨‡•à‡§¢‡§º‡§®, ‡§§‡§π‡§∏‡•Ä‡§≤: ‡§∏‡§ø‡§Ç‡§ó‡§∞‡•å‡§≤‡•Ä ‡§®‡§ó‡§∞&#10;‡§ú‡§ø‡§≤‡§æ: ‡§∏‡§ø‡§Ç‡§ó‡§∞‡•å‡§≤‡•Ä, ‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂</textarea>
                    </div>
                    <div class="cad-form-group" style="flex: 1; min-width: 250px; margin-bottom: 0;">
                        <label>‡§™‡§ü‡§µ‡§æ‡§∞‡•Ä ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§µ‡§ø‡§µ‡§∞‡§£ (‡§®‡•Ä‡§ö‡•á ‡§¶‡§æ‡§à‡§Ç ‡§ì‡§∞):</label>
                        <textarea id="docPatwari" rows="4" style="resize: vertical;">‡§π‡§≤‡•ç‡§ï‡§æ ‡§¨‡•à‡§¢‡§º‡§®, ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï 14&#10;‡§∞‡§æ.‡§®‡§ø. ‡§Æ‡§£‡•ç‡§°‡§≤: ‡§¨‡•à‡§¢‡§º‡§®&#10;‡§§‡§π‡§∏‡•Ä‡§≤: ‡§∏‡§ø‡§Ç‡§ó‡§∞‡•å‡§≤‡•Ä ‡§®‡§ó‡§∞</textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="cad-form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                        <label>‡§ó‡•ç‡§∞‡§æ‡§Æ/‡§®‡§ó‡§∞:</label>
                        <input type="text" id="docVillage" value="‡§ó‡§®‡§ø‡§Ø‡§æ‡§∞‡•Ä">
                    </div>
                    <div class="cad-form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                        <label>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï:</label>
                        <input type="text" id="docDate" placeholder="DD/MM/YYYY">
                    </div>
                    <div class="cad-form-group" style="flex: 2; min-width: 250px; margin-bottom: 0;">
                        <label>‡§ñ‡§∏‡§∞‡§æ, ‡§∞‡§ï‡§µ‡§æ ‡§µ ‡§≠‡•Ç-‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£:</label>
                        <textarea id="docKhasra" rows="4" style="resize: vertical;">1388/1/2/2 ‡§∞‡§ï‡§µ‡§æ 0.0220 ‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ (‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä ‡§ï‡•Å‡§∏‡•Å‡§Æ ‡§ï‡§≤‡•Ä ‡§ó‡•Å‡§™‡•ç‡§§‡§æ ‡§™‡§§‡§ø ‡§∏‡•Å‡§∞‡•á‡§®‡•ç‡§¶‡•ç‡§∞ ‡§™‡•ç‡§∞‡§∏‡§æ‡§¶ ‡§ó‡•Å‡§™‡•ç‡§§‡§æ)</textarea>
                    </div>
                </div>
            </div>

            <div class="cad-panel" id="editToolbar" style="display: none;">
                <button class="cad-btn cad-btn-danger" id="btnTrim" onclick="setEditMode('trim')">‡§ï‡•à‡§Ç‡§ö‡•Ä (‡§ï‡•ç‡§∞‡•â‡§∏‡§ø‡§Ç‡§ó ‡§π‡§ü‡§æ‡§è‡§Ç)</button>
                <button class="cad-btn" id="btnEditLine" onclick="setEditMode('editLine')">‡§≤‡§æ‡§á‡§® ‡§ñ‡§ø‡§∏‡§ï‡§æ‡§è‡§Ç (Nodes)</button>
                <div class="cad-divider"></div>
                <button class="cad-btn" id="btnSmartText" onclick="setEditMode('smartText')">‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§®‡§æ‡§Æ (‡§∏‡•ú‡§ï ‡§™‡§∞)</button>
                <button class="cad-btn" id="btnFreeTextEdit" onclick="setEditMode('freeText')">‡§´‡•ç‡§∞‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü</button>
                <button class="cad-btn cad-btn-dark" id="btnEditText" onclick="setEditMode('editText')">‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∏‡•á‡§≤‡•á‡§ï‡•ç‡§ü / ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                
                <div class="cad-control-group" id="textControls" style="display: none;">
                    <input type="text" id="textContentInput" class="cad-text-input" placeholder="‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç..." oninput="updateTextProp('content', this.value)" onchange="saveState()">
                    <label>‡§∏‡§æ‡§á‡•õ:</label>
                    <input type="range" id="textSizeSlider" min="15" max="100" value="35" style="width:70px;" oninput="updateTextProp('size', this.value)" onchange="saveState()">
                    <label>‡§ò‡•Å‡§Æ‡§æ‡§µ:</label>
                    <input type="range" id="textAngleSlider" min="-180" max="180" value="0" style="width:70px;" oninput="updateTextProp('angle', this.value)" onchange="saveState()">
                    <button class="cad-btn cad-btn-danger" style="padding: 4px 10px; margin-left: 10px; font-size: 12px;" onclick="deleteSelectedText()">üóëÔ∏è ‡§°‡§ø‡§≤‡•Ä‡§ü</button>
                </div>
            </div>

            <div class="cad-panel" id="sliderPanel">
                <div class="cad-control-group">
                    <label style="color:#c0392b;">‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡•ú‡§ï:</label>
                    <input type="range" id="mainWidthRange" min="10" max="500" value="75" oninput="syncWidths('main', this.value)">
                    <input type="number" id="mainWidthNum" class="cad-number-input" min="10" max="500" value="75" oninput="syncWidths('main', this.value)"> px
                </div>
                <div class="cad-control-group">
                    <label style="color:#d35400;">‡§≤‡§ø‡§Ç‡§ï ‡§∏‡•ú‡§ï:</label>
                    <input type="range" id="linkWidthRange" min="5" max="500" value="55" oninput="syncWidths('link', this.value)">
                    <input type="number" id="linkWidthNum" class="cad-number-input" min="5" max="500" value="55" oninput="syncWidths('link', this.value)"> px
                </div>
                <div class="cad-control-group">
                    <label style="color:#8e44ad;">‡§ï‡§ö‡•ç‡§ö‡§æ ‡§∞‡§æ‡§∏‡•ç‡§§‡§æ:</label>
                    <input type="range" id="kachchiWidthRange" min="5" max="500" value="45" oninput="syncWidths('kachchi', this.value)">
                    <input type="number" id="kachchiWidthNum" class="cad-number-input" min="5" max="500" value="45" oninput="syncWidths('kachchi', this.value)"> px
                </div>
            </div>

            <div class="cad-panel" id="exportPanel" style="display: none; background: #f8fafc; border-color: #cbd5e1;">
                <span style="font-weight: 600; color: var(--cad-text-muted); margin-right: 10px;">‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü:</span>
                <button class="cad-btn cad-btn-success" onclick="generateOfficialPDF()" style="font-size: 14px;">üñ®Ô∏è ‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡•õ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü (A4 Form)</button>
                <button class="cad-btn cad-btn-dark" onclick="downloadSVG()">SVG (Word Shapes)</button>
                <button class="cad-btn" onclick="downloadImage('png')">PNG</button>
                <button class="cad-btn" onclick="downloadImage('jpeg')">JPG</button>
            </div>

            <div id="instruction">‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§ñ‡•ã‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§®‡§Ø‡§æ ‡§Æ‡•à‡§™ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§ï‡§æ‡§Æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç‡•§</div>

            <div class="viewport" id="viewport">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="mapCanvas" width="1600" height="1740"></canvas>
                    <div id="cadDistanceBox">‡§¶‡•Ç‡§∞‡•Ä: <span id="cadDistValue"></span></div>
                </div>
            </div>
        </div>
        
        <div id="downTab" class="tab-content">
            <div class="card">
                <div class="section-title">
                    <span>File Repository (Github)</span>
                    <button class="btn" style="background:#2c3e50;" onclick="loadGithubFiles()">
                        ‚Üª Refresh List
                    </button>
                </div>
                
                <div id="fileLoader" style="display:none; text-align:center; padding:20px;">
                    Loading files from server...
                </div>
                <div id="filesContainer">
                </div>
            </div>
        </div>
    </div> <div id="printArea">
        <div class="document-container">
            <table class="header-table">
                <tr>
                    <td class="header-left">
                        <div id="printOfficeLine1" class="font-14 bold"></div>
                        <div id="printOfficeLine2" class="font-11 bold" style="white-space: pre-line; margin-top: 2px;"></div>
                    </td>
                    <td class="header-mid">
                        <table class="mid-table">
                            <tr>
                                <td class="title-cell font-14 bold">‡§®‡§ú‡§∞‡•Ä ‡§®‡§ï‡•ç‡§∂‡§æ (‡§ö‡•å‡§π‡§¶‡•ç‡§¶‡•Ä)</td>
                            </tr>
                            <tr>
                                <td class="date-cell font-11 regular">
                                    ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï : <span id="printDateValue" class="bold">_ _ _ _ _ _ _ _ 2026</span>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td class="header-right">
                        <img src="https://png.pngtree.com/png-vector/20230131/ourmid/pngtree-beautiful-compass-icon-vector-illustration-png-image_6580312.png" alt="Compass" class="compass-img">
                    </td>
                </tr>
            </table>

            <div class="map-area">
                <img id="printMapImage" style="width: 100%; height: 100%; object-fit: contain;" src="">
            </div>

            <div class="declaration-text font-11 regular">
                ‡§Ü‡§µ‡•á‡§¶‡§ï/‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä(‡§ó‡§£) ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§è‡§µ‡§Ç ‡§Æ‡•å‡§ï‡§æ ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§®‡§ú‡§∞‡•Ä ‡§®‡§ï‡•ç‡§∂‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§ø‡§Ø‡§æ‡•§
            </div>

            <div class="signature-line font-11 regular">
                ‡§π‡§∏‡•ç‡§§‡§æ. ‡§Ü‡§µ‡•á‡§¶‡§ï(‡§ó‡§£) ----------------------------------------
            </div>

            <table class="footer-layout-table">
                <tr>
                    <td style="width: 70%; padding: 0;">
                        <table class="footer-details-table">
                            <tr>
                                <td class="label-col font-11 regular">‡§ó‡•ç‡§∞‡§æ‡§Æ/‡§®‡§ó‡§∞:</td>
                                <td class="value-col font-11 bold" id="printVillage"></td>
                            </tr>
                            <tr>
                                <td class="label-col font-11 regular">‡§ñ‡§∏‡§∞‡§æ, ‡§∞‡§ï‡§µ‡§æ ‡§µ ‡§≠‡•Ç-<br>‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£:</td>
                                <td class="value-col font-11 bold" id="printKhasra"></td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 30%; padding: 0;">
                        <div class="patwari-block">
                            <div class="font-11 bold" style="margin-bottom: 5px;">‡§™‡§ü‡§µ‡§æ‡§∞‡•Ä</div>
                            <div class="font-11" id="printPatwari" style="white-space: pre-line;"></div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <div id="traceNaksha" class="tab-content">
    <div style="width: 100%; height: 85vh; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); background: white;">
        
        <iframe 
            src="https://rocktech-web.github.io/TraceNaksha.html" 
            style="width: 100%; height: 100%; border: none;"
            title="TraceNaksha">
        </iframe>

    </div>
</div>

    </div>


    <script>
        // --- AUTH & UI (ROCKTECH CORE) ---
        function checkLogin() {
            if(document.getElementById('userId').value === "RockTechnology" && document.getElementById('password').value === "Manish@31689") {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('navBar').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'block';
                drawCanvas(); 
            } else { document.getElementById('loginError').style.display = 'block'; }
        }
        function openTab(evt, name) {
            Array.from(document.getElementsByClassName('tab-content')).forEach(x => x.classList.remove('active'));
            Array.from(document.getElementsByClassName('tab-btn')).forEach(x => x.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            evt.currentTarget.classList.add('active');
        }
        
        // GENERIC COPY
        function copyData(id) { document.getElementById(id).select(); document.execCommand('copy'); }
        function copyBatwaraResult() { 
            const text = document.getElementById('resultText').innerText;
            if(!text) return alert("‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
            navigator.clipboard.writeText(text).then(() => { alert("‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à!"); }).catch(err => { alert("‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + err); });
        }

        // --- B1 EXTRACTOR LOGIC ---
        function processLandData() {
            const f = document.getElementById('fileInput').files[0];
            if(!f) return alert("Select File (.txt)");
            const r = new FileReader();
            
            r.onload = e => {
                const lines = e.target.result.split('\n');
                let gram = "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§";
                if(lines.length > 6) { let rawGram = lines[6]; if(rawGram.includes("‡§ó‡•ç‡§∞‡§æ‡§Æ")) { gram = rawGram.split(":")[1].trim().split(/\s+/)[0]; } }
                let khata = "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§";
                if(lines.length > 20) { let rawKhata = lines[20]; let match = rawKhata.match(/\d+/); if(match) khata = match[0]; }
                
                let owners = []; let nameBuffer = ""; 
                for(let i = 22; i < lines.length; i++) {
                    let line = lines[i].trim();
                    if(!line) continue;
                    if(line.includes("‡§™‡§§‡§æ")) {
                        if(nameBuffer) {
                            let cleanName = nameBuffer.trim(); let share = "0/1";
                            if(i + 1 < lines.length) { let shareLine = lines[i+1].trim(); share = shareLine.split(" ")[0]; }
                            owners.push(`${cleanName} ${share}`); nameBuffer = ""; i++; 
                        }
                    } 
                    else if(line.includes("‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä") || line.length < 2) continue;
                    else nameBuffer += line + " ";
                }

                let khasaras = []; let totalArea = 0.0;
                for(let i=0; i<lines.length; i++) {
                    if(lines[i].includes("(S)")) {
                        let parts = lines[i].trim().split(/\s+/); let kno = parts[0]; let areaLine = lines[i+1] || "";
                        if (areaLine.includes("‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞")) {
                            let val = areaLine.replace("‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞", "").trim(); khasaras.push(`${kno} ‡§∞‡§ï‡§µ‡§æ ${val}‡§π‡•á.`);
                            let vNum = parseFloat(val); if(!isNaN(vNum)) totalArea += vNum;
                        }
                    }
                }

                document.getElementById('ownersOutput').value = owners.join(", ");
                let header = `‡§ó‡•ç‡§∞‡§æ‡§Æ ${gram} ‡§∏‡•ç‡§•‡§ø‡§§ ‡§≠‡•Ç‡§Æ‡§ø ‡§ñ‡§æ‡§§‡§æ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï ${khata}, ‡§ñ‡§∏‡§∞‡§æ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï `;
                let list = khasaras.join(", ");
                let footer = `\n\n‡§ï‡§ø‡§§‡§æ ${khasaras.length} ‡§ï‡•Å‡§≤ ‡§∞‡§ï‡§µ‡§æ ${totalArea.toFixed(4)}‡§π‡•á.`;
                document.getElementById('khasaraOutput').value = header + list + footer;
            };
            r.readAsText(f);
        }

        // --- MATH & BATWARA LOGIC ---
        class Fraction {
            constructor(n,d){if(d===0n)throw new Error("Div0");if(d<0n){n=-n;d=-d}this.n=BigInt(n);this.d=BigInt(d);this.simplify()}
            static gcd(a,b){return b===0n?a:Fraction.gcd(b,a%b)}
            simplify(){if(this.n===0n){this.d=1n;return}let a=this.n<0n?-this.n:this.n,b=this.d,c=Fraction.gcd(a,b);this.n/=c;this.d/=c}
            add(f){return new Fraction(this.n*f.d+f.n*this.d,this.d*f.d)}
            sub(f){return new Fraction(this.n*f.d-f.n*this.d,this.d*f.d)}
            mul(f){return new Fraction(this.n*f.n,this.d*f.d)}
            div(f){return new Fraction(this.n*f.d,this.d*f.n)}
            toString(){return `${this.n}/${this.d}`}
            static fromString(s){if(!s)return new Fraction(0,1);s=s.toString().trim();if(s.includes('/')){let p=s.split('/');return new Fraction(p[0],p[1])}if(s.includes('.')){let p=s.split('.'),d=10n**BigInt(p[1].length);return new Fraction(BigInt(p[0]+p[1]),d)}return new Fraction(s,1)}
        }
        let rowData=[];
        function parseAndLoad(){
            rowData=[]; document.getElementById('rawInput').value.split('\n').forEach(l=>{
                l=l.trim();if(!l)return;let m=l.match(/(\d+\/\d+)$/);
                rowData.push({name:m?l.replace(m[0],"").trim():l, origShare:Fraction.fromString(m?m[0]:"0"), manualRemoveStr:"", isFullRemove:false});
            }); renderTable(); calculate();
        }
        function renderTable(){
            let tb=document.querySelector("#dataTable tbody");tb.innerHTML="";
            rowData.forEach((r,i)=>{
                tb.innerHTML+=`<tr>
                    <td><b>${i+1}</b></td>
                    <td>${r.name}</td>
                    <td class="res-text">${r.origShare.toString()}</td>
                    <td><div style="display:flex;gap:5px;"><input type="text" class="fraction-input" value="${r.manualRemoveStr}" onchange="upd(${i},this.value)" ${r.isFullRemove?'disabled':''}>
                    <button class="btn" style="padding:2px 8px;font-size:11px;${r.isFullRemove?'background:#c62828':''}" onclick="tog(${i})">${r.isFullRemove?'UNDO':'FULL'}</button></div></td>
                    <td class="res-text" id="d-${i}">-</td><td class="res-text" id="r-${i}">-</td><td class="res-text" id="n-${i}" style="color:green">-</td>
                </tr>`;
            });
        }
        function upd(i,v){rowData[i].manualRemoveStr=v;calculate()}
        function tog(i){rowData[i].isFullRemove=!rowData[i].isFullRemove;rowData[i].manualRemoveStr=rowData[i].isFullRemove?"FULL":"";renderTable();calculate()}
        function calculate(){
            try{
                let totA=Fraction.fromString(document.getElementById('totalArea').value||"1");
                let sumRem=new Fraction(0,1), states=[];
                rowData.forEach((r,i)=>{
                    let ded=new Fraction(0,1);
                    if(r.isFullRemove) ded=r.origShare;
                    else if(r.manualRemoveStr) ded=Fraction.fromString(r.manualRemoveStr).div(totA);
                    let rem=r.origShare.sub(ded); if(rem.n<0n)rem=new Fraction(0,1);
                    document.getElementById(`d-${i}`).innerText=ded.n===0n?"-":ded.toString();
                    document.getElementById(`r-${i}`).innerText=rem.toString();
                    sumRem=sumRem.add(rem); states.push(rem);
                });
                let out=[]; rowData.forEach((r,i)=>{
                    let ns="0"; if(states[i].n>0n&&sumRem.n>0n) ns=states[i].div(sumRem).toString();
                    document.getElementById(`n-${i}`).innerText=ns;
                    if(states[i].n>0n) out.push(`${r.name} ${ns}`);
                });
                document.getElementById('outputPanel').style.display='block';
                document.getElementById('resultText').innerText=out.join(", ");
            }catch(e){console.error(e)}
        }
        
        // Fraction Tools
        function calculateSum(){let s=new Fraction(0,1);document.getElementById('sumInput').value.split(/[\n,]+/).forEach(x=>{if(x.trim())s=s.add(Fraction.fromString(x))});document.getElementById('sumResult').innerText=s.toString()}
        function calculateSub(){document.getElementById('subResult').innerText=Fraction.fromString(document.getElementById('subMain').value).sub(Fraction.fromString(document.getElementById('subValues').value)).toString()}
        function calculateDiv(){document.getElementById('divResult').innerText=new Fraction(BigInt(Fraction.fromString(document.getElementById('divMain').value).n), Fraction.fromString(document.getElementById('divMain').value).d * BigInt(document.getElementById('divCount').value)).toString()}

        // --- DATA FORMATTER LOGIC ---
        function processFmt() {
            const raw = document.getElementById('fmtInput').value;
            if(!raw.trim()) return alert("‡§°‡§æ‡§ü‡§æ ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç!");
            const items = raw.replace(/\n/g, ',').split(',');
            const t1 = document.querySelector('#tblRaw tbody');
            const t2 = document.querySelector('#tblDetail tbody');
            t1.innerHTML = ""; t2.innerHTML = "";
            let hasData = false;

            items.forEach(item => {
                let text = item.trim(); if(!text) return;
                t1.innerHTML += `<tr><td>${text}</td></tr>`;
                
                let match = text.match(/(\d+\/\d+)$/); let name = text; let share = "-"; let num = ""; let den = "";
                if(match) {
                    share = match[0]; name = text.replace(share, "").trim();
                    let p = share.split('/'); num = p[0]; den = p[1];
                }
                t2.innerHTML += `<tr><td>${name}</td><td>${share}</td><td>${num}</td><td>${den}</td></tr>`;
                hasData = true;
            });

            if(hasData) document.getElementById('fmtResult').style.display = "grid";
        }

        function copyTable(id) {
            const el = document.getElementById(id); const range = document.createRange(); range.selectNode(el);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
            document.execCommand('copy'); window.getSelection().removeAllRanges(); alert("‡§ü‡•á‡§¨‡§≤ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§à!");
        }

        // --- GITHUB FILE DOWNLOADER LOGIC ---
        async function loadGithubFiles() {
            const owner = 'rocktech-web'; const repo = 'AllFormats'; const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/`;
            const container = document.getElementById('filesContainer'); const loader = document.getElementById('fileLoader');
            container.innerHTML = ""; loader.style.display = "block";

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Repository not found or private");
                const data = await response.json();
                
                const grouped = {};
                data.forEach(file => {
                    if (file.type === 'file') {
                        const ext = file.name.split('.').pop().toUpperCase();
                        if (!grouped[ext]) grouped[ext] = []; grouped[ext].push(file);
                    }
                });

                loader.style.display = "none";
                if (Object.keys(grouped).length === 0) { container.innerHTML = "<p>No files found in repository.</p>"; return; }

                for (const [ext, files] of Object.entries(grouped)) {
                    let sectionHtml = `
                        <div style="margin-bottom: 25px; border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                            <div style="background: #e9ecef; padding: 10px 15px; font-weight: bold; color: #2c3e50; border-bottom: 1px solid #ddd;">üìÇ ${ext} FILES (${files.length})</div>
                            <div class="table-wrap"><table><thead><tr><th width="70%">File Name</th><th width="15%">Size</th><th width="15%">Action</th></tr></thead><tbody>
                    `;
                    files.forEach(file => {
                        let sizeKB = (file.size / 1024).toFixed(1) + ' KB';
                        sectionHtml += `<tr><td>${file.name}</td><td>${sizeKB}</td><td><button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="verifyAndDownload('${file.download_url}')">‚¨á Download</button></td></tr>`;
                    });
                    sectionHtml += `</tbody></table></div></div>`;
                    container.innerHTML += sectionHtml;
                }
            } catch (error) {
                loader.style.display = "none";
                container.innerHTML = `<p style="color:red;">Error: ${error.message}. <br>Make sure the repository is Public.</p>`;
            }
        }

        function verifyAndDownload(url) {
            let code = prompt("‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (Enter Code to Download):");
            if (code === "258") window.open(url, '_blank');
            else if (code !== null) alert("‚ùå ‡§ó‡§≤‡§§ ‡§ï‡•ã‡§°! ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡•§");
        }


        // =========================================================================
        // NAZRI NAKSHA (CAD TOOL) JAVASCRIPT LOGIC
        // =========================================================================

        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');
        const cadBox = document.getElementById('cadDistanceBox');
        const cadValue = document.getElementById('cadDistValue');
        
        let uploadedImage = null; let mode = null; let editMode = null; 
        let isGenerated = false; let currentZoom = 1;
        
        let historyStack = []; let finalSegments = []; let finalTexts = [];
        let undoStack = []; let redoStack = [];

        function resetCanvasState() {
            uploadedImage = null; mode = null; editMode = null; isGenerated = false; currentZoom = 1;
            historyStack = []; finalSegments = []; finalTexts = []; undoStack = []; redoStack = [];
            currentPath = []; typedDistance = ""; snapPoint = null;
            document.getElementById('imageInput').value = "";
            restoreState({isGenerated: false, historyStack: [], finalSegments: [], finalTexts: []});
            drawCanvas();
        }
        
        function saveProject() {
            const projectData = {
                version: "1.1", 
                imgSrc: uploadedImage ? uploadedImage.src : null,
                historyStack: historyStack, 
                finalSegments: finalSegments, 
                finalTexts: finalTexts,
                isGenerated: isGenerated,
                widths: { 
                    main: document.getElementById('mainWidthNum').value, 
                    link: document.getElementById('linkWidthNum').value, 
                    kachchi: document.getElementById('kachchiWidthNum').value 
                },
                docDetails: {
                    office: document.getElementById('docOffice').value,
                    village: document.getElementById('docVillage').value,
                    date: document.getElementById('docDate').value,
                    khasra: document.getElementById('docKhasra').value,
                    patwari: document.getElementById('docPatwari').value
                }
            };
            const blob = new Blob([JSON.stringify(projectData)], {type: "application/json"});
            saveAs(blob, "RockTech_Project.json");
        }

        document.getElementById('projectInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    historyStack = data.historyStack || []; 
                    finalSegments = data.finalSegments || []; 
                    finalTexts = data.finalTexts || []; 
                    isGenerated = data.isGenerated || false;
                    
                    if(data.widths) {
                        ['main', 'link', 'kachchi'].forEach(type => {
                            if(data.widths[type] !== undefined) {
                                document.getElementById(type + 'WidthRange').value = data.widths[type];
                                document.getElementById(type + 'WidthNum').value = data.widths[type];
                            }
                        });
                    }
                    if(data.docDetails) {
                        document.getElementById('docOffice').value = data.docDetails.office || "";
                        document.getElementById('docVillage').value = data.docDetails.village || "";
                        document.getElementById('docDate').value = data.docDetails.date || "";
                        document.getElementById('docKhasra').value = data.docDetails.khasra || "";
                        document.getElementById('docPatwari').value = data.docDetails.patwari || "";
                    }
                    if(data.imgSrc) {
                        uploadedImage = new Image(); 
                        uploadedImage.onload = () => restoreState({isGenerated, historyStack, finalSegments, finalTexts}); 
                        uploadedImage.src = data.imgSrc;
                    } else { 
                        uploadedImage = null; 
                        restoreState({isGenerated, historyStack, finalSegments, finalTexts}); 
                    }
                } catch(err) { alert("‡§´‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§™‡•ù‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! ‡§∏‡§π‡•Ä RockTech_Project.json ‡§´‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§"); }
            };
            reader.readAsText(file);
            e.target.value = ''; // reset
        });

        function saveState() {
            undoStack.push({ isGenerated: isGenerated, historyStack: JSON.parse(JSON.stringify(historyStack)), finalSegments: JSON.parse(JSON.stringify(finalSegments)), finalTexts: JSON.parse(JSON.stringify(finalTexts)) });
            redoStack = []; 
        }

        function undo() {
            if(undoStack.length > 0) {
                redoStack.push({ isGenerated, historyStack: JSON.parse(JSON.stringify(historyStack)), finalSegments: JSON.parse(JSON.stringify(finalSegments)), finalTexts: JSON.parse(JSON.stringify(finalTexts)) });
                restoreState(undoStack.pop());
            }
        }

        function redo() {
            if(redoStack.length > 0) {
                undoStack.push({ isGenerated, historyStack: JSON.parse(JSON.stringify(historyStack)), finalSegments: JSON.parse(JSON.stringify(finalSegments)), finalTexts: JSON.parse(JSON.stringify(finalTexts)) });
                restoreState(redoStack.pop());
            }
        }

        function restoreState(state) {
            isGenerated = state.isGenerated; historyStack = state.historyStack; finalSegments = state.finalSegments; finalTexts = state.finalTexts;
            
            document.getElementById('drawToolbar').style.display = isGenerated ? 'none' : 'flex';
            document.getElementById('sliderPanel').style.display = isGenerated ? 'none' : 'flex';
            document.getElementById('editToolbar').style.display = isGenerated ? 'flex' : 'none';
            document.getElementById('exportPanel').style.display = isGenerated ? 'flex' : 'none';
            document.getElementById('docDetailsPanel').style.display = isGenerated ? 'flex' : 'none';
            
            if(!isGenerated) { currentPath = []; mode = null; document.querySelectorAll('.active-tool').forEach(el => el.classList.remove('active-tool')); }
            selectedTextIdx = -1; hoveredNode = null; drawCanvas();
        }

        function changeZoom(delta) {
            currentZoom += delta; if(currentZoom < 0.4) currentZoom = 0.4; if(currentZoom > 4) currentZoom = 4;
            wrapper.style.transform = `scale(${currentZoom})`; wrapper.style.width = `calc(160mm * ${currentZoom})`; wrapper.style.height = `calc(174mm * ${currentZoom})`;
        }

        let currentPath = []; let mousePos = {x: 0, y: 0}; let typedDistance = ""; let snapPoint = null; 
        let hoverSegmentIdx = -1; let selectedTextIdx = -1; let isDraggingText = false;
        let hoveredNode = null; let draggedNode = null; 

        document.getElementById('imageInput').addEventListener('change', function(e) {
            if(e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    uploadedImage = new Image(); uploadedImage.onload = () => { saveState(); drawCanvas(); }; uploadedImage.src = event.target.result;
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        function syncWidths(type, val) {
            if(val === "") return; document.getElementById(type + 'WidthRange').value = val; document.getElementById(type + 'WidthNum').value = val;
            if(isGenerated) { regenerateSegments(); drawCanvas(); } else { drawCanvas(); }
        }

        function getWidth(type) { return parseInt(document.getElementById(type + 'WidthNum').value) || 20; }

        function setMode(newMode) {
            if(isGenerated) return;
            if(currentPath.length > 0) { saveState(); historyStack.push({ type: mode, points: [...currentPath] }); currentPath = []; typedDistance=""; }
            mode = newMode;
            ['btnMain', 'btnLink', 'btnKachchi', 'btnRail', 'btnPlot', 'btnText'].forEach(id => document.getElementById(id).classList.remove('active-tool'));
            let btnMap = {'main':'btnMain', 'link':'btnLink', 'kachchi':'btnKachchi', 'rail':'btnRail', 'plot':'btnPlot', 'text':'btnText'};
            if(btnMap[mode]) document.getElementById(btnMap[mode]).classList.add('active-tool');
        }

        function setEditMode(newMode) {
            editMode = newMode;
            ['btnTrim', 'btnSmartText', 'btnFreeTextEdit', 'btnEditText', 'btnEditLine'].forEach(id => document.getElementById(id).classList.remove('active-tool'));
            document.getElementById('textControls').style.display = 'none';

            if(editMode === 'trim') { document.getElementById('btnTrim').classList.add('active-tool'); document.getElementById('instruction').textContent = "‡§ï‡•à‡§Ç‡§ö‡•Ä: ‡§è‡§ï‡•ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§æ ‡§≤‡§æ‡§á‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§Æ‡§ø‡§ü‡§æ‡§è‡§Ç‡•§"; canvas.style.cursor = 'crosshair'; }
            if(editMode === 'editLine') { document.getElementById('btnEditLine').classList.add('active-tool'); document.getElementById('instruction').textContent = "‡§®‡•ã‡§° ‡§ñ‡§ø‡§∏‡§ï‡§æ‡§è‡§Ç: ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§≤‡§æ‡§á‡§® ‡§ï‡•á ‡§ï‡•ã‡§®‡•á (‡§π‡§∞‡•á ‡§ó‡•ã‡§≤‡•á) ‡§ï‡•ã ‡§™‡§ï‡•ú ‡§ï‡§∞ ‡§ñ‡§ø‡§∏‡§ï‡§æ‡§è‡§Ç‡•§"; canvas.style.cursor = 'move'; }
            if(editMode === 'smartText') { document.getElementById('btnSmartText').classList.add('active-tool'); document.getElementById('instruction').textContent = "‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§®‡§æ‡§Æ: ‡§∏‡•ú‡§ï ‡§ï‡•Ä ‡§≤‡§æ‡§á‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§"; canvas.style.cursor = 'pointer'; }
            if(editMode === 'freeText') { document.getElementById('btnFreeTextEdit').classList.add('active-tool'); document.getElementById('instruction').textContent = "‡§´‡•ç‡§∞‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü: ‡§ï‡§π‡•Ä‡§Ç ‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§"; canvas.style.cursor = 'text'; }
            if(editMode === 'editText') { 
                document.getElementById('btnEditText').classList.add('active-tool'); 
                document.getElementById('instruction').textContent = "‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§è‡§°‡§ø‡§ü: ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§ñ‡§ø‡§∏‡§ï‡§æ‡§è‡§Ç, ‡§∏‡§æ‡§á‡•õ ‡§¨‡§¶‡§≤‡•á‡§Ç, ‡§ò‡•Å‡§Æ‡§æ‡§è‡§Ç ‡§Ø‡§æ ‡§∂‡§¨‡•ç‡§¶ ‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç‡•§"; 
                document.getElementById('textControls').style.display = 'flex'; canvas.style.cursor = 'default'; 
            }
            hoverSegmentIdx = -1; selectedTextIdx = -1; hoveredNode = null; draggedNode = null; drawCanvas();
        }

        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: (e.clientX - rect.left) * (canvas.width / rect.width), y: (e.clientY - rect.top) * (canvas.height / rect.height) };
        }

        function spawnFloatingTextarea(e, onSave) {
            if(document.querySelector('.floating-input-container')) return; 
            const container = document.createElement('div'); container.className = 'floating-input-container';
            container.style.left = e.pageX + 'px'; container.style.top = (e.pageY - 20) + 'px';

            const textarea = document.createElement('textarea'); textarea.className = 'floating-textarea'; textarea.placeholder = "‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≤‡§ø‡§ñ‡•á‡§Ç... (‡§®‡§à ‡§≤‡§æ‡§á‡§® ‡§ï‡•á ‡§≤‡§ø‡§è Enter ‡§¶‡§¨‡§æ‡§è‡§Ç)";
            const btn = document.createElement('button'); btn.textContent = "‚úî ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç"; btn.className = "cad-btn cad-btn-primary"; btn.style.marginTop = "5px";

            container.appendChild(textarea); container.appendChild(btn); document.body.appendChild(container); textarea.focus();

            const saveText = () => {
                let val = textarea.value.trim(); if(val !== "") onSave(val);
                if(document.body.contains(container)) document.body.removeChild(container); drawCanvas();
            };
            btn.addEventListener('click', saveText);
        }

        function promptSingleLine(msg, onSave) { let val = prompt(msg); if(val && val.trim() !== "") onSave(val.trim()); }

        function updateTextProp(prop, val) {
            if (isGenerated && selectedTextIdx !== -1 && finalTexts[selectedTextIdx]) {
                if(prop === 'size') finalTexts[selectedTextIdx].fontSize = parseInt(val);
                if(prop === 'angle') finalTexts[selectedTextIdx].angle = parseInt(val) * (Math.PI / 180); 
                if(prop === 'content') finalTexts[selectedTextIdx].text = val; 
                drawCanvas();
            }
        }
        
        function deleteSelectedText() {
            if (isGenerated && selectedTextIdx !== -1) {
                saveState(); finalTexts.splice(selectedTextIdx, 1); selectedTextIdx = -1; document.getElementById('textContentInput').value = ""; drawCanvas(); 
            }
        }

        function findClosestText(p) {
            let minDist = 40; let bestIdx = -1;
            for(let i=0; i<finalTexts.length; i++) {
                let dist = Math.hypot(p.x - finalTexts[i].x, p.y - finalTexts[i].y);
                if(dist < minDist) { minDist = dist; bestIdx = i; }
            } return bestIdx;
        }

        function findClosestNode(p) {
            let minDist = 30; let bestNode = null;
            for(let i=0; i<finalSegments.length; i++) {
                let d1 = Math.hypot(p.x - finalSegments[i].A.x, p.y - finalSegments[i].A.y); let d2 = Math.hypot(p.x - finalSegments[i].B.x, p.y - finalSegments[i].B.y);
                if(d1 < minDist) { minDist = d1; bestNode = {segIdx: i, isA: true}; } if(d2 < minDist) { minDist = d2; bestNode = {segIdx: i, isA: false}; }
            } return bestNode;
        }

        window.addEventListener('keydown', (e) => {
            if(!isGenerated && currentPath.length > 0 && mode && mode !== 'text') {
                if((e.key >= '0' && e.key <= '9') || e.key === '.') { typedDistance += e.key; drawCanvas(); } 
                else if(e.key === 'Backspace') { typedDistance = typedDistance.slice(0, -1); drawCanvas(); } 
                else if(e.key === 'Enter' && typedDistance !== "") {
                    let lastPt = currentPath[currentPath.length - 1]; let angle = Math.atan2(mousePos.y - lastPt.y, mousePos.x - lastPt.x);
                    saveState(); currentPath.push({x: lastPt.x + Math.cos(angle) * parseFloat(typedDistance), y: lastPt.y + Math.sin(angle) * parseFloat(typedDistance)}); typedDistance = ""; drawCanvas();
                }
            }
        });

        wrapper.addEventListener('mousemove', (e) => {
            mousePos = getCoords(e);
            if (isGenerated) {
                if (editMode === 'trim' || editMode === 'smartText') { hoverSegmentIdx = findClosestSegment(mousePos); drawCanvas(); } 
                else if (editMode === 'editLine') {
                    if (draggedNode) {
                        if(draggedNode.isA) finalSegments[draggedNode.segIdx].A = {x: mousePos.x, y: mousePos.y}; else finalSegments[draggedNode.segIdx].B = {x: mousePos.x, y: mousePos.y}; drawCanvas();
                    } else { hoveredNode = findClosestNode(mousePos); drawCanvas(); }
                }
                else if (editMode === 'editText' && isDraggingText && selectedTextIdx !== -1) { finalTexts[selectedTextIdx].x = mousePos.x; finalTexts[selectedTextIdx].y = mousePos.y; drawCanvas(); }
            } else if (!isGenerated && currentPath.length > 0) {
                let startPt = currentPath[0]; let distToStart = Math.hypot(mousePos.x - startPt.x, mousePos.y - startPt.y); snapPoint = (distToStart < 30 && currentPath.length > 2) ? startPt : null; drawCanvas(); 
            }
        });

        window.addEventListener('mouseup', () => { isDraggingText = false; if(draggedNode) { draggedNode = null; saveState(); } });

        wrapper.addEventListener('mousedown', (e) => {
            if(document.querySelector('.floating-input-container')) return; 
            const coords = getCoords(e);

            if (isGenerated) {
                if (editMode === 'trim' && hoverSegmentIdx !== -1) { saveState(); finalSegments.splice(hoverSegmentIdx, 1); hoverSegmentIdx = -1; drawCanvas(); }
                else if (editMode === 'editLine' && hoveredNode) { saveState(); draggedNode = hoveredNode; }
                else if (editMode === 'smartText') {
                    let segIdx = findClosestSegment(coords);
                    if(segIdx !== -1) {
                        let seg = finalSegments[segIdx]; let midX = (seg.A.x + seg.B.x) / 2; let midY = (seg.A.y + seg.B.y) / 2;
                        let angle = Math.atan2(seg.B.y - seg.A.y, seg.B.x - seg.A.x); if (angle > Math.PI/2) angle -= Math.PI; if (angle < -Math.PI/2) angle += Math.PI;
                        promptSingleLine("‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:", (val) => { saveState(); let size = parseInt(document.getElementById('textSizeSlider').value) || 35; finalTexts.push({ text: val, x: midX, y: midY, angle: angle, fontSize: size }); drawCanvas(); });
                    } else { alert("‡§∏‡•ú‡§ï ‡§ï‡•Ä ‡§≤‡§æ‡§á‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§"); }
                }
                else if (editMode === 'freeText') {
                    spawnFloatingTextarea(e, (val) => { saveState(); let size = parseInt(document.getElementById('textSizeSlider').value) || 35; finalTexts.push({ text: val, x: coords.x, y: coords.y, angle: 0, fontSize: size }); drawCanvas(); });
                }
                else if (editMode === 'editText') {
                    let clickedIdx = findClosestText(coords);
                    if(clickedIdx !== -1) {
                        saveState(); selectedTextIdx = clickedIdx; isDraggingText = true;
                        document.getElementById('textSizeSlider').value = finalTexts[clickedIdx].fontSize || 35;
                        document.getElementById('textAngleSlider').value = Math.round((finalTexts[clickedIdx].angle || 0) * (180/Math.PI));
                        document.getElementById('textContentInput').value = finalTexts[clickedIdx].text; 
                        drawCanvas();
                    } else { selectedTextIdx = -1; document.getElementById('textContentInput').value = ""; drawCanvas(); }
                }
                return;
            }

            if(!mode) return;
            if(mode === 'text') {
                spawnFloatingTextarea(e, (val) => { saveState(); let size = parseInt(document.getElementById('mainWidthNum').value) || 35; historyStack.push({ type: 'text', text: val, x: coords.x, y: coords.y, angle: 0, fontSize: size }); drawCanvas(); });
                return;
            }

            saveState();
            if(snapPoint) { currentPath.push({x: snapPoint.x, y: snapPoint.y}); historyStack.push({ type: mode, points: [...currentPath] }); currentPath = []; snapPoint = null; typedDistance = ""; } 
            else if(typedDistance !== "") { let lastPt = currentPath[currentPath.length - 1]; let angle = Math.atan2(coords.y - lastPt.y, coords.x - lastPt.x); currentPath.push({x: lastPt.x + Math.cos(angle) * parseFloat(typedDistance), y: lastPt.y + Math.sin(angle) * parseFloat(typedDistance)}); typedDistance = ""; } 
            else { currentPath.push(coords); }
            drawCanvas();
        });

        canvas.addEventListener('dblclick', () => {
            if(mode === 'text' || !mode || currentPath.length === 0 || isGenerated) return;
            saveState(); historyStack.push({ type: mode, points: [...currentPath] }); currentPath = []; typedDistance = ""; snapPoint = null; drawCanvas();
        });

        function getParallelPaths(pts, width) {
            let left = [], right = []; let halfW = width / 2;
            for(let i=0; i<pts.length; i++) {
                let p = pts[i]; let v1, v2;
                if(i === 0) { v1 = {x: pts[1].x - p.x, y: pts[1].y - p.y}; v2 = v1; } 
                else if (i === pts.length - 1) { v1 = {x: p.x - pts[i-1].x, y: p.y - pts[i-1].y}; v2 = v1; } 
                else { v1 = {x: p.x - pts[i-1].x, y: p.y - pts[i-1].y}; v2 = {x: pts[i+1].x - p.x, y: pts[i+1].y - p.y}; }
                let len1 = Math.hypot(v1.x, v1.y) || 1; v1 = {x: v1.x/len1, y: v1.y/len1}; let len2 = Math.hypot(v2.x, v2.y) || 1; v2 = {x: v2.x/len2, y: v2.y/len2};
                let tangent = {x: v1.x + v2.x, y: v1.y + v2.y}; let tLen = Math.hypot(tangent.x, tangent.y); if(tLen === 0) tangent = v1; else tangent = {x: tangent.x/tLen, y: tangent.y/tLen};
                let normal = {x: -tangent.y, y: tangent.x}; let n1 = {x: -v1.y, y: v1.x}; let dot = normal.x * n1.x + normal.y * n1.y; let miter = dot !== 0 ? 1/dot : 1;
                if (Math.abs(miter) > 3) miter = 3 * Math.sign(miter); 
                left.push({x: p.x + normal.x * halfW * miter, y: p.y + normal.y * halfW * miter}); right.push({x: p.x - normal.x * halfW * miter, y: p.y - normal.y * halfW * miter});
            } return {left, right};
        }

        function getRailwayTicks(pts) {
            let ticks = []; let tickSpacing = 30; let tickWidth = 25; let totalLength = 0; let distances = [0];
            for(let i=1; i<pts.length; i++) { totalLength += Math.hypot(pts[i].x - pts[i-1].x, pts[i].y - pts[i-1].y); distances.push(totalLength); }
            let currentDist = tickSpacing / 2; let pIdx = 1;
            while(currentDist < totalLength && pIdx < pts.length) {
                if(currentDist > distances[pIdx]) { pIdx++; continue; }
                let prev = pts[pIdx-1], curr = pts[pIdx]; let ratio = (currentDist - distances[pIdx-1]) / (distances[pIdx] - distances[pIdx-1]);
                let x = prev.x + (curr.x - prev.x) * ratio; let y = prev.y + (curr.y - prev.y) * ratio; let dx = curr.x - prev.x, dy = curr.y - prev.y; let len = Math.hypot(dx, dy) || 1; let nx = -dy/len, ny = dx/len;
                ticks.push([ {x: x + nx*(tickWidth/2), y: y + ny*(tickWidth/2)}, {x: x - nx*(tickWidth/2), y: y - ny*(tickWidth/2)} ]); currentDist += tickSpacing;
            } return ticks;
        }

        function getIntersection(A, B, C, D) {
            let bottom = (D.y - C.y) * (B.x - A.x) - (D.x - C.x) * (B.y - A.y); if (Math.abs(bottom) < 0.0001) return null;
            let t = ((D.x - C.x) * (A.y - C.y) - (D.y - C.y) * (A.x - C.x)) / bottom; let u = ((B.x - A.x) * (A.y - C.y) - (B.y - A.y) * (A.x - C.x)) / bottom;
            if (t > 0.01 && t < 0.99 && u > 0.01 && u < 0.99) { return { x: A.x + t * (B.x - A.x), y: A.y + t * (B.y - A.y) }; } return null;
        }

        function shatterSegments(segs) {
            let result = [...segs]; let foundSplit = true; let maxIters = 1000;
            while(foundSplit && maxIters-- > 0) {
                foundSplit = false;
                for(let i=0; i<result.length; i++) {
                    for(let j=i+1; j<result.length; j++) {
                        let intP = getIntersection(result[i].A, result[i].B, result[j].A, result[j].B);
                        if(intP) {
                            let s1 = result[i], s2 = result[j];
                            result.splice(j, 1, {A: intP, B: s2.B, dash: s2.dash}, {A: s2.A, B: intP, dash: s2.dash});
                            result.splice(i, 1, {A: intP, B: s1.B, dash: s1.dash}, {A: s1.A, B: intP, dash: s1.dash});
                            foundSplit = true; break;
                        }
                    } if(foundSplit) break;
                }
            } return result;
        }

        function pointToSegmentDistance(p, v, w) {
            let l2 = (v.x - w.x)**2 + (v.y - w.y)**2; if (l2 === 0) return Math.hypot(p.x - v.x, p.y - v.y);
            let t = Math.max(0, Math.min(1, ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2)); return Math.hypot(p.x - (v.x + t * (w.x - v.x)), p.y - (v.y + t * (w.y - v.y)));
        }

        function findClosestSegment(p) {
            let minDist = 30; let bestIdx = -1;
            for(let i=0; i<finalSegments.length; i++) { let dist = pointToSegmentDistance(p, finalSegments[i].A, finalSegments[i].B); if(dist < minDist) { minDist = dist; bestIdx = i; } } return bestIdx;
        }

        function drawPathArray(ctx, pts) {
            if(pts.length < 2) return; ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
            for(let i=1; i<pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y); ctx.stroke();
        }

        function renderDraftElement(el) {
            if(el.type === 'text') return;
            ctx.strokeStyle = el.type==='main' ? '#c0392b' : el.type==='link' ? '#d35400' : el.type==='kachchi' ? '#8e44ad' : '#16a085'; ctx.lineWidth = 4; 
            let w = el.type === 'main' ? getWidth('main') : el.type === 'link' ? getWidth('link') : getWidth('kachchi');

            if(el.type === 'rail' || el.type === 'plot') {
                drawPathArray(ctx, el.points); if(el.type === 'rail') getRailwayTicks(el.points).forEach(t => drawPathArray(ctx, t));
            } else {
                let parallels = getParallelPaths(el.points, w); if(el.type === 'kachchi') ctx.setLineDash([20, 20]);
                drawPathArray(ctx, parallels.left); drawPathArray(ctx, parallels.right); ctx.setLineDash([]); 
            }
        }

        function drawTexts(sourceArray, isFinal) {
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            sourceArray.forEach((el, idx) => {
                if(el.type === 'text' || el.text) {
                    let txt = el.text || el.text; let size = el.fontSize || 35; ctx.font = `600 ${size}px Poppins, Arial`;
                    ctx.fillStyle = (isFinal && idx === selectedTextIdx && editMode === 'editText') ? "#e74c3c" : (isFinal ? "#000" : "#2980b9");
                    ctx.save(); ctx.translate(el.x, el.y); ctx.rotate(el.angle || 0);
                    let lines = txt.split('\n'); let lineHeight = size * 1.2; let startY = -((lines.length - 1) * lineHeight) / 2;
                    lines.forEach((line, i) => { let lineY = startY + (i * lineHeight); if(isFinal) { ctx.lineWidth = Math.max(2, size/6); ctx.strokeStyle = "white"; ctx.strokeText(line, 0, lineY); } ctx.fillText(line, 0, lineY); });
                    ctx.restore();
                }
            });
        }

        function regenerateSegments() {
            let initialSegments = [];
            historyStack.forEach(el => {
                if (el.type === 'text') return; 
                let w = el.type === 'main' ? getWidth('main') : el.type === 'link' ? getWidth('link') : getWidth('kachchi');
                if (el.type === 'rail' || el.type === 'plot') {
                    for(let i=0; i<el.points.length-1; i++) initialSegments.push({A: el.points[i], B: el.points[i+1], dash: false});
                    if(el.type === 'rail') getRailwayTicks(el.points).forEach(t => initialSegments.push({A: t[0], B: t[1], dash: false}));
                } else {
                    let parallels = getParallelPaths(el.points, w); let isDash = el.type === 'kachchi';
                    for(let i=0; i<parallels.left.length-1; i++) initialSegments.push({A: parallels.left[i], B: parallels.left[i+1], dash: isDash});
                    for(let i=0; i<parallels.right.length-1; i++) initialSegments.push({A: parallels.right[i], B: parallels.right[i+1], dash: isDash});
                }
            });
            finalSegments = shatterSegments(initialSegments);
        }

        function drawCanvas() {
            if(!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height); cadBox.style.display = 'none'; 
            if (!isGenerated) {
                if (uploadedImage) { 
                    ctx.globalAlpha = 0.4; let imgRatio = uploadedImage.width / uploadedImage.height; let canvasRatio = canvas.width / canvas.height; let drawW, drawH, drawX, drawY;
                    if (imgRatio > canvasRatio) { drawW = canvas.width; drawH = canvas.width / imgRatio; drawX = 0; drawY = (canvas.height - drawH) / 2; } 
                    else { drawH = canvas.height; drawW = canvas.height * imgRatio; drawX = (canvas.width - drawW) / 2; drawY = 0; }
                    ctx.drawImage(uploadedImage, drawX, drawY, drawW, drawH); ctx.globalAlpha = 1.0; 
                }
                historyStack.forEach(el => renderDraftElement(el));
                if(currentPath.length > 0) {
                    renderDraftElement({ type: mode, points: currentPath }); let lastPt = currentPath[currentPath.length - 1]; let previewPt = {x: mousePos.x, y: mousePos.y};
                    if(typedDistance !== "") { let angle = Math.atan2(mousePos.y - lastPt.y, mousePos.x - lastPt.x); let dist = parseFloat(typedDistance); previewPt = {x: lastPt.x + Math.cos(angle)*dist, y: lastPt.y + Math.sin(angle)*dist}; cadBox.style.display = 'block'; cadBox.style.left = (event.pageX + 15) + 'px'; cadBox.style.top = (event.pageY - 20) + 'px'; cadValue.textContent = typedDistance; } 
                    else if(snapPoint) { previewPt = snapPoint; ctx.beginPath(); ctx.arc(snapPoint.x, snapPoint.y, 15, 0, 2*Math.PI); ctx.fillStyle = "rgba(46, 204, 113, 0.6)"; ctx.fill(); ctx.strokeStyle = "#27ae60"; ctx.lineWidth=3; ctx.stroke(); }
                    ctx.beginPath(); ctx.moveTo(lastPt.x, lastPt.y); ctx.lineTo(previewPt.x, previewPt.y); ctx.strokeStyle = "rgba(41, 128, 185, 0.7)"; ctx.lineWidth = 3; ctx.setLineDash([10, 10]); ctx.stroke(); ctx.setLineDash([]);
                }
                drawTexts(historyStack, false);
            } else {
                ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.lineWidth = 2; ctx.lineCap = 'round';
                finalSegments.forEach((s, idx) => {
                    ctx.strokeStyle = (idx === hoverSegmentIdx && (editMode==='trim'||editMode==='smartText')) ? "#e74c3c" : "#000000"; ctx.lineWidth = (idx === hoverSegmentIdx) ? 6 : 2; 
                    if (s.dash) ctx.setLineDash([15, 15]); else ctx.setLineDash([]);
                    ctx.beginPath(); ctx.moveTo(s.A.x, s.A.y); ctx.lineTo(s.B.x, s.B.y); ctx.stroke();
                }); ctx.setLineDash([]); 
                if(editMode === 'editLine' && hoveredNode && !draggedNode) { let pt = hoveredNode.isA ? finalSegments[hoveredNode.segIdx].A : finalSegments[hoveredNode.segIdx].B; ctx.beginPath(); ctx.arc(pt.x, pt.y, 15, 0, 2*Math.PI); ctx.fillStyle = "rgba(46, 204, 113, 0.6)"; ctx.fill(); ctx.strokeStyle = "#27ae60"; ctx.lineWidth=3; ctx.stroke(); }
                drawTexts(finalTexts, true);
            }
        }

        function generateLineArt() {
            saveState();
            if(currentPath.length > 0 && mode !== 'text') { historyStack.push({ type: mode, points: [...currentPath] }); currentPath = []; typedDistance=""; }
            if(!isGenerated) { finalTexts = []; historyStack.forEach(el => { if (el.type === 'text') { finalTexts.push({ text: el.text, x: el.x, y: el.y, angle: el.angle || 0, fontSize: el.fontSize || 35 }); } }); }
            regenerateSegments(); isGenerated = true;
            
            document.getElementById('drawToolbar').style.display = 'none'; 
            document.getElementById('sliderPanel').style.display = 'none'; 
            document.getElementById('docDetailsPanel').style.display = 'flex'; 
            document.getElementById('editToolbar').style.display = 'flex'; 
            document.getElementById('exportPanel').style.display = 'flex'; 
            setEditMode('editText'); 
            
            if(!document.getElementById('docDate').value) {
                document.getElementById('docDate').value = new Date().toLocaleDateString('en-GB');
            }
        }

        function generateOfficialPDF() {
            let officeLines = document.getElementById('docOffice').value.split('\n');
            document.getElementById('printOfficeLine1').innerText = officeLines[0] || "";
            document.getElementById('printOfficeLine2').innerText = officeLines.slice(1).join('\n') || "";
            document.getElementById('printVillage').innerText = document.getElementById('docVillage').value;
            document.getElementById('printKhasra').innerText = document.getElementById('docKhasra').value;
            document.getElementById('printPatwari').innerText = document.getElementById('docPatwari').value;
            
            let dateVal = document.getElementById('docDate').value; 
            document.getElementById('printDateValue').innerText = dateVal ? dateVal : "_ _ _ _ _ _ _ _ 2026";
            
            document.getElementById('printMapImage').src = canvas.toDataURL('image/jpeg', 1.0);
            
            setTimeout(() => { window.print(); }, 300);
        }

        function downloadImage(format) { const link = document.createElement('a'); link.download = `RockTech_Map.${format}`; link.href = canvas.toDataURL(`image/${format}`, 1.0); link.click(); }
        
        function downloadSVG() {
            let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 1740" width="160mm" height="174mm" style="width:160mm; height:174mm;">\n<rect width="100%" height="100%" fill="white" stroke="none"/>\n`;
            finalSegments.forEach(s => { let dash = s.dash ? `stroke-dasharray="15,15"` : ""; svg += `<line x1="${s.A.x}" y1="${s.A.y}" x2="${s.B.x}" y2="${s.B.y}" stroke="black" stroke-width="2" stroke-linecap="round" ${dash} />\n`; });
            finalTexts.forEach(el => {
                let deg = el.angle * (180 / Math.PI); let size = el.fontSize || 35; let strokeW = Math.max(2, size/6);
                let lines = el.text.split('\n'); let lineHeight = size * 1.2; let startY = el.y - ((lines.length - 1) * lineHeight) / 2;
                let whiteTextGrp = `<text font-family="Poppins, Arial" font-size="${size}" font-weight="600" fill="white" stroke="white" stroke-width="${strokeW}" text-anchor="middle" transform="rotate(${deg}, ${el.x}, ${el.y})">\n`;
                let blackTextGrp = `<text font-family="Poppins, Arial" font-size="${size}" font-weight="600" fill="black" stroke="none" text-anchor="middle" transform="rotate(${deg}, ${el.x}, ${el.y})">\n`;
                lines.forEach((line, i) => { let lineY = startY + (i * lineHeight) + (size * 0.3); whiteTextGrp += `<tspan x="${el.x}" y="${lineY}">${line}</tspan>\n`; blackTextGrp += `<tspan x="${el.x}" y="${lineY}">${line}</tspan>\n`; });
                whiteTextGrp += `</text>\n`; blackTextGrp += `</text>\n`; svg += whiteTextGrp + blackTextGrp;
            });
            svg += `</svg>`; saveAs(new Blob([svg], {type: "image/svg+xml;charset=utf-8"}), "RockTech_Word_Shapes.svg");
        }
        
        // Ensure fonts are loaded before drawing initial empty canvas state
        document.fonts.ready.then(() => { if(document.getElementById('mapCanvas')) drawCanvas(); });
    </script>
</body>
</html>





