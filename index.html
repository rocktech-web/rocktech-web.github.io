<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock Technology | Pro Land Management Suite</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* =========================================
           GLOBAL VARIABLES
           ========================================= */
        :root {
            /* RockTech Pro Dashboard Vars */
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #e67e22;
            --bg-body: #f4f6f9;
            --text-main: #333;
            --text-muted: #7f8c8d;
            --sidebar-width: 260px;
            --header-height: 60px;
            --transition: all 0.3s ease;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);

            /* CAD TOOL VARS */
            --cad-bg-panel: #ffffff;
            --cad-text-main: #0f172a;
            --cad-text-muted: #475569;
            --cad-border-light: #e2e8f0;
            --cad-border-dark: #cbd5e1;
            --cad-primary: #2563eb; 
            --cad-primary-hover: #1d4ed8;
            --cad-secondary: #0f172a; 
            --cad-secondary-hover: #1e293b;
            --cad-success: #059669; 
            --cad-danger: #dc2626; 
            --print-border: #000000;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-main);
        }

        /* =========================================
           LOGIN OVERLAY
           ========================================= */
        #loginOverlay {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(135deg, #2c3e50 0%, #000 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 15px;
            width: 320px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .login-card input {
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd;
            border-radius: 6px; box-sizing: border-box; font-size: 16px;
        }

        /* =========================================
           SIDEBAR & LAYOUT (NEW)
           ========================================= */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary);
            color: #fff;
            display: none; /* Login ke pehle hidden */
            flex-direction: column;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            height: var(--header-height); display: flex; align-items: center; padding: 0 20px;
            background: rgba(0,0,0,0.1); font-size: 1.2rem; font-weight: 700; letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .sidebar-header span { color: var(--accent); }

        .sidebar-menu { flex: 1; overflow-y: auto; padding: 15px 0; }
        .menu-category { padding: 15px 20px 5px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #95a5a6; font-weight: 600; }
        
        .nav-btn {
            width: 100%; background: transparent; border: none; color: #bdc3c7; padding: 12px 20px;
            text-align: left; font-size: 0.95rem; font-family: inherit; cursor: pointer; transition: var(--transition);
            border-left: 4px solid transparent; display: flex; align-items: center; gap: 10px;
        }
        .nav-btn:hover { background: var(--primary-light); color: #fff; }
        .nav-btn.active { background: var(--primary-light); color: #fff; border-left-color: var(--accent); font-weight: 600; }

        .main-wrapper { flex: 1; display: none; /* Login ke pehle hidden */ flex-direction: column; min-width: 0; }
        
        .top-header {
            height: var(--header-height); background: #fff; display: flex; align-items: center;
            padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 900; justify-content: space-between;
        }
        .toggle-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer; display: none; }
        .header-right { display: flex; align-items: center; gap: 15px; font-weight: 600; color: var(--primary); font-family: monospace; font-size: 1.1rem; }

        .content-area { flex: 1; padding: 25px; overflow-y: auto; background-color: var(--bg-body); }

        /* =========================================
           TOOL CARDS & INPUTS (ORIGINAL)
           ========================================= */
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid #eee; }
        .section-title { font-size: 1.4rem; color: var(--primary); margin: 0 0 20px 0; border-left: 5px solid var(--accent); padding-left: 15px; display: flex; justify-content: space-between; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        textarea, input[type="text"], input[type="number"], input[type="file"] {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; font-size: 14px; box-sizing: border-box;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus { border-color: var(--accent); outline: none; }
        
        button.btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: var(--transition); }
        button.btn:hover { background: var(--accent); transform: translateY(-1px); }
        button.btn-outline { background: transparent; border: 1px solid #999; color: #555; }
        button.btn-outline:hover { background: #eee; }

        .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #e0e0e0; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 800px; }
        th { background: #f8f9fa; color: #555; padding: 12px; text-align: left; border-bottom: 2px solid #eee; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; }
        .fraction-input { width: 80px; text-align: center; border: 1px solid #ddd; }
        .res-text { font-family: monospace; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2 style="margin-top:0; color:var(--primary);">Rock Technology</h2>
            <p>Secure Access</p>
            <input type="text" id="userId" placeholder="User ID">
            <input type="password" id="password" placeholder="Password">
            <button class="btn" style="width:100%; margin-top:15px;" onclick="checkLogin()">LOGIN</button>
            <p id="loginError" style="color:red; display:none; margin-top:10px; font-size:14px;">Invalid Credentials!</p>
        </div>
    </div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            Rock<span>Tech</span>
        </div>
        <div class="sidebar-menu">
            <div class="menu-category">‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</div>
            <button class="nav-btn active" onclick="switchTab(event, 'extTab')">üìÑ B1 Extractor</button>
            <button class="nav-btn" onclick="switchTab(event, 'fmtTab')">üìä Data Formatter</button>

            <div class="menu-category">‡§∞‡§æ‡§ú‡§∏‡•ç‡§µ ‡§ó‡§£‡§®‡§æ</div>
            <button class="nav-btn" onclick="switchTab(event, 'batTab')">‚öñÔ∏è Batwara Calc</button>
            <button class="nav-btn" onclick="switchTab(event, 'fracTab')">üßÆ Fraction Calc</button>

            <div class="menu-category">‡§®‡§ï‡•ç‡§∂‡§æ ‡§è‡§µ‡§Ç ‡§∞‡•á‡§ñ‡§æ‡§Ç‡§ï‡§®</div>
            <button class="nav-btn" onclick="switchTab(event, 'nakshaTab')">üó∫Ô∏è Nazri Naksha</button>
            <button class="nav-btn" onclick="switchTab(event, 'traceNaksha')">‚úèÔ∏è Trace Naksha</button>

            <div class="menu-category">‡§Ö‡§®‡•ç‡§Ø ‡§ü‡•Ç‡§≤‡•ç‡§∏</div>
            <button class="nav-btn" onclick="switchTab(event, 'downTab')">‚¨áÔ∏è Download Formats</button>
        </div>
    </nav>

    <div class="main-wrapper" id="mainWrapper">
        <header class="top-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
                <span style="font-weight: 600; color: var(--primary); font-family: monospace; font-size: 1.1rem;">üìû 7869731689</span>
            </div>
            
            <button onclick="if(confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§ü ‡§ú‡§æ‡§è‡§ó‡§æ‡•§')) location.reload();" 
                    style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: inherit; font-size: 14px; transition: 0.2s; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);">
                üö™ Logout
            </button>
        </header>

        <main class="content-area" id="mainApp">
            
            <div id="extTab" class="tab-content active">
                <div class="card">
                    <div class="section-title">MP Land Records Extractor (Smart Logic)</div>
                    <div style="background:#f8f9fa; padding:15px; border-radius:8px; display:flex; gap:10px; align-items:center;">
                        <input type="file" id="fileInput" accept=".txt" style="border:none;">
                        <button class="btn" onclick="processLandData()">Extract Data</button>
                    </div>
                </div>
                <div class="grid">
                    <div class="card">
                        <div class="section-title">Owners & Shares <button class="btn btn-outline" style="font-size:12px; padding:5px 10px;" onclick="copyData('ownersOutput')">Copy</button></div>
                        <textarea id="ownersOutput" rows="12" placeholder="Owner Names and Shares will appear here..."></textarea>
                    </div>
                    <div class="card">
                        <div class="section-title">Khasara & Area <button class="btn btn-outline" style="font-size:12px; padding:5px 10px;" onclick="copyData('khasaraOutput')">Copy</button></div>
                        <textarea id="khasaraOutput" rows="12" placeholder="Village, Khata and Khasara details..."></textarea>
                    </div>
                </div>
            </div>

            <div id="batTab" class="tab-content">
                <div class="card">
                    <div class="section-title">
                        <span>‡§¨‡§ü‡§µ‡§æ‡§∞‡§æ ‡§ó‡§£‡§®‡§æ (Proportional Renormalization)</span>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 3fr;">
                        <div style="background:#fff8e1; padding:15px; border-radius:8px; border:1px solid #ffe0b2;">
                            <label style="font-weight:bold; color:#f57c00;">‡§ï‡•Å‡§≤ ‡§∞‡§ï‡§¨‡§æ (Total Area)</label>
                            <input type="text" id="totalArea" value="0.6000" style="margin-top:5px; font-weight:bold;">
                            <button class="btn" style="width:100%; margin-top:15px;" onclick="parseAndLoad()">‡§°‡§æ‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                        <div>
                            <textarea id="rawInput" rows="5" placeholder="‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="card" style="padding:0; overflow:hidden;">
                    <div class="table-wrap">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th width="5%">‡§ï‡•ç‡§∞.</th>
                                    <th width="20%">‡§®‡§æ‡§Æ</th>
                                    <th width="10%">‡§Æ‡•Ç‡§≤ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ</th>
                                    <th width="25%">‡§π‡§ü‡§æ‡§®‡§æ (‡§∞‡§ï‡§¨‡§æ ‡§Ø‡§æ FULL)</th>
                                    <th width="10%">‡§ò‡§ü‡§æ‡§Ø‡§æ ‡§≠‡§ø‡§®‡•ç‡§®</th>
                                    <th width="10%">‡§∂‡•á‡§∑ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ</th>
                                    <th width="20%">‡§™‡•Å‡§®‡§∞‡•ç‡§®‡§ø‡§ß‡§æ‡§∞‡§ø‡§§ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div style="padding:15px; background:#f1f1f1; text-align:right;">
                        <button class="btn" onclick="calculate()">‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç (Calculate)</button>
                    </div>
                </div>
                <div id="outputPanel" class="card" style="display:none; background:#e8f5e9; border:1px solid #c8e6c9;">
                    <div class="section-title" style="border-left-color:#2e7d32; margin-bottom:10px;">
                        <span style="color:#2e7d32;">‡§™‡§∞‡§ø‡§£‡§æ‡§Æ</span>
                        <button class="btn" style="background:#2e7d32;" onclick="copyBatwaraResult()">Copy Text</button>
                    </div>
                    <div id="resultText" style="background:white; padding:15px; border-radius:6px; font-family:monospace; margin-bottom:10px; border:1px solid #ccc;"></div>
                </div>
            </div>

            <div id="fracTab" class="tab-content">
                <div class="card">
                    <div class="section-title">Fraction Tools</div>
                    <div class="grid">
                        <div>
                            <label><b>Add Fractions</b></label>
                            <textarea id="sumInput" rows="3"></textarea>
                            <button class="btn" style="margin-top:5px;" onclick="calculateSum()">Sum</button>
                            <div id="sumResult" class="res-text" style="margin-top:10px; color:var(--accent);"></div>
                        </div>
                        <div>
                            <label><b>Subtract / Divide</b></label>
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                <input type="text" id="subMain" placeholder="Main">
                                <input type="text" id="subValues" placeholder="Sub">
                            </div>
                            <button class="btn" style="margin-top:5px;" onclick="calculateSub()">Subtract</button>
                            <div id="subResult" class="res-text" style="margin-top:5px; color:var(--accent);"></div>
                            
                            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                                <div style="display:flex; gap:10px;">
                                    <input type="text" id="divMain" placeholder="Frac">
                                    <input type="number" id="divCount" placeholder="Parts">
                                </div>
                                <button class="btn" style="margin-top:5px;" onclick="calculateDiv()">Divide</button>
                                <div id="divResult" class="res-text" style="margin-top:5px; color:var(--accent);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="fmtTab" class="tab-content">
                <div class="card">
                    <div class="section-title">Data Formatter (Table Generator)</div>
                    <div class="grid" style="grid-template-columns: 1fr;">
                        <div>
                            <label><b>‡§°‡§æ‡§ü‡§æ ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç (Comma Separated):</b></label>
                            <textarea id="fmtInput" rows="5" placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: ‡§∞‡§æ‡§Æ 1/4, ‡§∂‡•ç‡§Ø‡§æ‡§Æ 1/4..."></textarea>
                            <button class="btn" style="margin-top:15px;" onclick="processFmt()">Format Data</button>
                        </div>
                    </div>
                </div>

                <div id="fmtResult" class="grid" style="display:none; grid-template-columns: 1fr 2fr;">
                    <div class="card">
                        <div class="section-title">
                            <span>Table 1: ‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£</span>
                            <button class="btn btn-outline" style="font-size:11px; padding:2px 8px;" onclick="copyTable('tblRaw')">Copy</button>
                        </div>
                        <div class="table-wrap">
                            <table id="tblRaw">
                                <thead><tr><th>‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‚Äç‡§µ‡§æ‡§Æ‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ + ‡§π‡§ø‡§∏‡•ç‚Äç‡§∏‡§æ</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <div class="section-title">
                            <span>Table 2: ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£</span>
                            <button class="btn btn-outline" style="font-size:11px; padding:2px 8px;" onclick="copyTable('tblDetail')">Copy</button>
                        </div>
                        <div class="table-wrap">
                            <table id="tblDetail">
                                <thead>
                                    <tr><th>‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‚Äç‡§µ‡§æ‡§Æ‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§π‡§ø‡§∏‡•ç‚Äç‡§∏‡§æ</th><th>‡§Ö‡§Ç‡§∂</th><th>‡§π‡§∞</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="nakshaTab" class="tab-content">
                <div style="width: 100%; height: 85vh; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); background: white;">
                    <iframe src="https://rocktech-web.github.io/NajriNaksha.html" style="width: 100%; height: 100%; border: none;" title="NajriNaksha"></iframe>
                </div>
            </div>

            <div id="traceNaksha" class="tab-content">
                <div style="width: 100%; height: 85vh; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); background: white;">
                    <iframe src="https://rocktech-web.github.io/TraceNaksha.html" style="width: 100%; height: 100%; border: none;" title="TraceNaksha"></iframe>
                </div>
            </div>
            
            <div id="downTab" class="tab-content">
                <div class="card">
                    <div class="section-title">
                        <span>File Repository (Github)</span>
                        <button class="btn" style="background:#2c3e50;" onclick="loadGithubFiles()">‚Üª Refresh List</button>
                    </div>
                    <div id="fileLoader" style="display:none; text-align:center; padding:20px;">Loading files from server...</div>
                    <div id="filesContainer"></div>
                </div>
            </div>

        </main>
    </div>



    <script>
        // --- NEW SIDEBAR & AUTH LOGIC ---
        function checkLogin() {
            if(document.getElementById('userId').value === "RockTechnology" && document.getElementById('password').value === "Manish@31689") {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('sidebar').style.display = 'flex';
                document.getElementById('mainWrapper').style.display = 'flex';
                drawCanvas(); 
            } else { document.getElementById('loginError').style.display = 'block'; }
        }

        function switchTab(evt, tabId) {
            Array.from(document.getElementsByClassName('tab-content')).forEach(x => x.classList.remove('active'));
            Array.from(document.getElementsByClassName('nav-btn')).forEach(x => x.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            evt.currentTarget.classList.add('active');
            if (window.innerWidth <= 992) document.getElementById('sidebar').classList.remove('show');
            if(tabId === 'nakshaTab') drawCanvas();
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }

        // --- GENERIC COPY ---
        function copyData(id) { document.getElementById(id).select(); document.execCommand('copy'); }
        function copyBatwaraResult() { 
            const text = document.getElementById('resultText').innerText;
            if(!text) return alert("‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
            navigator.clipboard.writeText(text).then(() => { alert("‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à!"); }).catch(err => { alert("‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + err); });
        }

        // --- B1 EXTRACTOR LOGIC ---
        function processLandData() {
            const f = document.getElementById('fileInput').files[0];
            if(!f) return alert("Select File (.txt)");
            const r = new FileReader();
            r.onload = e => {
                const lines = e.target.result.split('\n'); let gram = "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§";
                if(lines.length > 6) { let rawGram = lines[6]; if(rawGram.includes("‡§ó‡•ç‡§∞‡§æ‡§Æ")) { gram = rawGram.split(":")[1].trim().split(/\s+/)[0]; } }
                let khata = "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§"; if(lines.length > 20) { let rawKhata = lines[20]; let match = rawKhata.match(/\d+/); if(match) khata = match[0]; }
                
                let owners = []; let nameBuffer = ""; 
                for(let i = 22; i < lines.length; i++) {
                    let line = lines[i].trim(); if(!line) continue;
                    if(line.includes("‡§™‡§§‡§æ")) {
                        if(nameBuffer) { let cleanName = nameBuffer.trim(); let share = "0/1";
                            if(i + 1 < lines.length) { let shareLine = lines[i+1].trim(); share = shareLine.split(" ")[0]; }
                            owners.push(`${cleanName} ${share}`); nameBuffer = ""; i++; }
                    } else if(line.includes("‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä") || line.length < 2) continue; else nameBuffer += line + " ";
                }

                let khasaras = []; let totalArea = 0.0;
                for(let i=0; i<lines.length; i++) {
                    if(lines[i].includes("(S)")) {
                        let parts = lines[i].trim().split(/\s+/); let kno = parts[0]; let areaLine = lines[i+1] || "";
                        if (areaLine.includes("‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞")) { let val = areaLine.replace("‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞", "").trim(); khasaras.push(`${kno} ‡§∞‡§ï‡§µ‡§æ ${val}‡§π‡•á.`); let vNum = parseFloat(val); if(!isNaN(vNum)) totalArea += vNum; }
                    }
                }
                document.getElementById('ownersOutput').value = owners.join(", ");
                let header = `‡§ó‡•ç‡§∞‡§æ‡§Æ ${gram} ‡§∏‡•ç‡§•‡§ø‡§§ ‡§≠‡•Ç‡§Æ‡§ø ‡§ñ‡§æ‡§§‡§æ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï ${khata}, ‡§ñ‡§∏‡§∞‡§æ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï `; let list = khasaras.join(", "); let footer = `\n\n‡§ï‡§ø‡§§‡§æ ${khasaras.length} ‡§ï‡•Å‡§≤ ‡§∞‡§ï‡§µ‡§æ ${totalArea.toFixed(4)}‡§π‡•á.`;
                document.getElementById('khasaraOutput').value = header + list + footer;
            }; r.readAsText(f);
        }

        // --- MATH & BATWARA LOGIC ---
        class Fraction {
            constructor(n,d){if(d===0n)throw new Error("Div0");if(d<0n){n=-n;d=-d}this.n=BigInt(n);this.d=BigInt(d);this.simplify()}
            static gcd(a,b){return b===0n?a:Fraction.gcd(b,a%b)}
            simplify(){if(this.n===0n){this.d=1n;return}let a=this.n<0n?-this.n:this.n,b=this.d,c=Fraction.gcd(a,b);this.n/=c;this.d/=c}
            add(f){return new Fraction(this.n*f.d+f.n*this.d,this.d*f.d)}
            sub(f){return new Fraction(this.n*f.d-f.n*this.d,this.d*f.d)}
            mul(f){return new Fraction(this.n*f.n,this.d*f.d)}
            div(f){return new Fraction(this.n*f.d,this.d*f.n)}
            toString(){return `${this.n}/${this.d}`}
            static fromString(s){if(!s)return new Fraction(0,1);s=s.toString().trim();if(s.includes('/')){let p=s.split('/');return new Fraction(p[0],p[1])}if(s.includes('.')){let p=s.split('.'),d=10n**BigInt(p[1].length);return new Fraction(BigInt(p[0]+p[1]),d)}return new Fraction(s,1)}
        }
        let rowData=[];
        function parseAndLoad(){
            rowData=[]; document.getElementById('rawInput').value.split('\n').forEach(l=>{
                l=l.trim();if(!l)return;let m=l.match(/(\d+\/\d+)$/);
                rowData.push({name:m?l.replace(m[0],"").trim():l, origShare:Fraction.fromString(m?m[0]:"0"), manualRemoveStr:"", isFullRemove:false});
            }); renderTable(); calculate();
        }
        function renderTable(){
            let tb=document.querySelector("#dataTable tbody");tb.innerHTML="";
            rowData.forEach((r,i)=>{
                tb.innerHTML+=`<tr>
                    <td><b>${i+1}</b></td><td>${r.name}</td><td class="res-text">${r.origShare.toString()}</td>
                    <td><div style="display:flex;gap:5px;"><input type="text" class="fraction-input" value="${r.manualRemoveStr}" onchange="upd(${i},this.value)" ${r.isFullRemove?'disabled':''}>
                    <button class="btn" style="padding:2px 8px;font-size:11px;${r.isFullRemove?'background:#c62828':''}" onclick="tog(${i})">${r.isFullRemove?'UNDO':'FULL'}</button></div></td>
                    <td class="res-text" id="d-${i}">-</td><td class="res-text" id="r-${i}">-</td><td class="res-text" id="n-${i}" style="color:green">-</td>
                </tr>`;
            });
        }
        function upd(i,v){rowData[i].manualRemoveStr=v;calculate()}
        function tog(i){rowData[i].isFullRemove=!rowData[i].isFullRemove;rowData[i].manualRemoveStr=rowData[i].isFullRemove?"FULL":"";renderTable();calculate()}
        function calculate(){
            try{
                let totA=Fraction.fromString(document.getElementById('totalArea').value||"1"); let sumRem=new Fraction(0,1), states=[];
                rowData.forEach((r,i)=>{
                    let ded=new Fraction(0,1); if(r.isFullRemove) ded=r.origShare; else if(r.manualRemoveStr) ded=Fraction.fromString(r.manualRemoveStr).div(totA);
                    let rem=r.origShare.sub(ded); if(rem.n<0n)rem=new Fraction(0,1);
                    document.getElementById(`d-${i}`).innerText=ded.n===0n?"-":ded.toString(); document.getElementById(`r-${i}`).innerText=rem.toString();
                    sumRem=sumRem.add(rem); states.push(rem);
                });
                let out=[]; rowData.forEach((r,i)=>{
                    let ns="0"; if(states[i].n>0n&&sumRem.n>0n) ns=states[i].div(sumRem).toString(); document.getElementById(`n-${i}`).innerText=ns;
                    if(states[i].n>0n) out.push(`${r.name} ${ns}`);
                });
                document.getElementById('outputPanel').style.display='block'; document.getElementById('resultText').innerText=out.join(", ");
            }catch(e){console.error(e)}
        }
        
        // Fraction Tools
        function calculateSum(){let s=new Fraction(0,1);document.getElementById('sumInput').value.split(/[\n,]+/).forEach(x=>{if(x.trim())s=s.add(Fraction.fromString(x))});document.getElementById('sumResult').innerText=s.toString()}
        function calculateSub(){document.getElementById('subResult').innerText=Fraction.fromString(document.getElementById('subMain').value).sub(Fraction.fromString(document.getElementById('subValues').value)).toString()}
        function calculateDiv(){document.getElementById('divResult').innerText=new Fraction(BigInt(Fraction.fromString(document.getElementById('divMain').value).n), Fraction.fromString(document.getElementById('divMain').value).d * BigInt(document.getElementById('divCount').value)).toString()}

        // --- DATA FORMATTER LOGIC ---
        function processFmt() {
            const raw = document.getElementById('fmtInput').value; if(!raw.trim()) return alert("‡§°‡§æ‡§ü‡§æ ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç!");
            const items = raw.replace(/\n/g, ',').split(','); const t1 = document.querySelector('#tblRaw tbody'); const t2 = document.querySelector('#tblDetail tbody');
            t1.innerHTML = ""; t2.innerHTML = ""; let hasData = false;
            items.forEach(item => {
                let text = item.trim(); if(!text) return; t1.innerHTML += `<tr><td>${text}</td></tr>`;
                let match = text.match(/(\d+\/\d+)$/); let name = text; let share = "-"; let num = ""; let den = "";
                if(match) { share = match[0]; name = text.replace(share, "").trim(); let p = share.split('/'); num = p[0]; den = p[1]; }
                t2.innerHTML += `<tr><td>${name}</td><td>${share}</td><td>${num}</td><td>${den}</td></tr>`; hasData = true;
            });
            if(hasData) document.getElementById('fmtResult').style.display = "grid";
        }
        function copyTable(id) { const el = document.getElementById(id); const range = document.createRange(); range.selectNode(el); window.getSelection().removeAllRanges(); window.getSelection().addRange(range); document.execCommand('copy'); window.getSelection().removeAllRanges(); alert("‡§ü‡•á‡§¨‡§≤ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§à!"); }

        // --- GITHUB FILE DOWNLOADER LOGIC ---
        async function loadGithubFiles() {
            const owner = 'rocktech-web'; const repo = 'AllFormats'; const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/`;
            const container = document.getElementById('filesContainer'); const loader = document.getElementById('fileLoader'); container.innerHTML = ""; loader.style.display = "block";
            try {
                const response = await fetch(apiUrl); if (!response.ok) throw new Error("Repository not found or private"); const data = await response.json();
                const grouped = {}; data.forEach(file => { if (file.type === 'file') { const ext = file.name.split('.').pop().toUpperCase(); if (!grouped[ext]) grouped[ext] = []; grouped[ext].push(file); } });
                loader.style.display = "none"; if (Object.keys(grouped).length === 0) { container.innerHTML = "<p>No files found in repository.</p>"; return; }
                for (const [ext, files] of Object.entries(grouped)) {
                    let sectionHtml = `<div style="margin-bottom: 25px; border: 1px solid #eee; border-radius: 8px; overflow: hidden;"><div style="background: #e9ecef; padding: 10px 15px; font-weight: bold; color: #2c3e50; border-bottom: 1px solid #ddd;">üìÇ ${ext} FILES (${files.length})</div><div class="table-wrap"><table><thead><tr><th width="70%">File Name</th><th width="15%">Size</th><th width="15%">Action</th></tr></thead><tbody>`;
                    files.forEach(file => { let sizeKB = (file.size / 1024).toFixed(1) + ' KB'; sectionHtml += `<tr><td>${file.name}</td><td>${sizeKB}</td><td><button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="verifyAndDownload('${file.download_url}')">‚¨á Download</button></td></tr>`; });
                    sectionHtml += `</tbody></table></div></div>`; container.innerHTML += sectionHtml;
                }
            } catch (error) { loader.style.display = "none"; container.innerHTML = `<p style="color:red;">Error: ${error.message}. <br>Make sure the repository is Public.</p>`; }
        }
        function verifyAndDownload(url) { let code = prompt("‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (Enter Code to Download):"); if (code === "258") window.open(url, '_blank'); else if (code !== null) alert("‚ùå ‡§ó‡§≤‡§§ ‡§ï‡•ã‡§°! ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡•§"); }


    </script>
</body>
</html>

